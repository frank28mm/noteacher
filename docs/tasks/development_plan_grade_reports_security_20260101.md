# å¼€å‘æ‰§è¡Œè®¡åˆ’ï¼ˆGrade æ€§èƒ½/è´¨é‡ + Reports/Worker/RLS + å¯†é’¥æ²»ç†ï¼‰

> æœ¬è®¡åˆ’æ˜¯â€œå½“å‰ä¸€è½®æ‰§è¡Œè®¡åˆ’/è·Ÿè¸ªè¡¨â€ï¼Œä» `docs/cto_90_day_plan.md`ï¼ˆè·¯çº¿å›¾ï¼‰ä¸ `docs/agent/next_development_worklist_and_pseudocode.md`ï¼ˆBacklogï¼‰ä¸­æŠ½å–å¿…è¦æ¡ç›®ï¼Œå¹¶è¡¥é½æˆ‘ä»¬æœ€è¿‘è®¨è®ºçš„ Ark Responses APIã€image_processã€RLS/æƒé™ä¸ schema å£å¾„å¯¹é½çš„è½åœ°ç»†èŠ‚ã€‚
>
> åŸåˆ™ï¼š**ä¸æ–°å¢ç¬¬äºŒä»½è·¯çº¿å›¾/Backlog**ï¼›æœ¬æ–‡ä»¶åªè´Ÿè´£â€œæŠŠè¦åšçš„äº‹åˆ—æ¸…æ¥šã€å¯éªŒæ”¶ã€å¯è¿½è¸ªâ€ã€‚

## 0) ç›®æ ‡ä¸éç›®æ ‡

### 0.1 ç›®æ ‡ï¼ˆç”¨æˆ·å¯æ„ŸçŸ¥ï¼‰

- **å·®å¼‚åŒ–è´¨é‡**ï¼šå¯¹é”™åˆ¤å®šå¿…é¡»å¯è§£é‡Šï¼ˆjudgment_basis/è¯æ®é“¾ï¼‰ï¼Œè¯æ®ä¸è¶³æ˜ç¡®æ ‡æ³¨ `uncertain/needs_review`ï¼Œæ‹’ç»â€œçœ‹èµ·æ¥å¾ˆå¿«ä½†äº’ç›¸çŸ›ç›¾â€çš„è¾“å‡ºã€‚
- **ä½“éªŒå¯æ§**ï¼šæŠŠ `/grade` çš„æ…¢æ‹†è§£æˆå¯é‡åŒ–åˆ†é¡¹ï¼ˆæŠ“å›¾/å‹ç¼©/å®šä½/LLM æ¨ç†/DB å†™å…¥ï¼‰ï¼Œèƒ½å®šä½ç“¶é¢ˆå¹¶åšä¼˜åŒ–å†³ç­–ã€‚
- **é—­ç¯å¯æ‰©å±•**ï¼šæŠ¥å‘Šé“¾è·¯ä» grade/chat è§£è€¦ï¼ˆå¼‚æ­¥ã€å¯é‡è·‘ã€å¯å®¡è®¡ï¼‰ï¼Œä¸ºâ€œå­¦æƒ…åˆ†æå¸ˆ subagentâ€æä¾›ç¨³å®šè¾“å…¥ã€‚

### 0.2 æ˜ç¡®ä¸åšï¼ˆæœ¬é˜¶æ®µä¸åšï¼‰

- ä¸åšâ€œæŒ‰ç­çº§/å¹´çº§/æ•™æç‰ˆæœ¬åˆ†ç¾¤å¯¹æ¯”â€ã€‚
- ä¸åšâ€œè¿›æ­¥/é€€æ­¥å½’å› åˆ°ç»ƒä¹ é‡â€ã€‚

## 1) ç°çŠ¶æ ¸å¯¹ï¼ˆåŸºäºä»£ç /DB çœŸç›¸ï¼‰

### 1.1 å·²è½åœ°ï¼ˆå·²å®Œæˆï¼‰

- Ark Responses APIï¼š
  - å°† system prompt ä» `system role message` è¿ç§»åˆ°é¡¶å±‚ `instructions=...`ï¼ˆé™ä½å…¼å®¹æ€§é£é™©ï¼‰ã€‚
  - æ”¯æŒ `ARK_IMAGE_PROCESS_ENABLED` å¼€å…³ï¼ˆå¼€å¯å†…ç½® `image_process` å·¥å…·ï¼›å¤±è´¥è‡ªåŠ¨å›é€€æ—  toolsï¼‰ã€‚
  - `/grade` è®°å½•å¹¶æŒä¹…åŒ– Ark `response_id`ï¼ˆä¾¿äºç”¨å®˜æ–¹ GET API æŸ¥è¯â€œæ‹‰å›¾/å·¥å…·/è¾“å…¥â€ï¼‰ã€‚
- `/grade` æ€§èƒ½æ‹†è§£ï¼š
  - åœ¨ qbank meta å†™å…¥ `timings_ms`ï¼ˆpreprocess/tools/compress/LLM/DB ç­‰åˆ†é¡¹ï¼‰ã€‚
  - å¢åŠ  `/grade` å›¾ç‰‡è¾“å…¥ç­–ç•¥å®éªŒï¼š`GRADE_IMAGE_INPUT_VARIANT=auto|url|proxy|data_url_first_page|data_url_on_small_figure`ï¼ˆæ”¯æŒ header è¦†ç›–ï¼‰ã€‚
- A/B/C ç»“è®ºç•™æ¡£ï¼š
  - å·²ç”Ÿæˆå¹¶ç•™æ¡£ï¼š`docs/archive/reports/perf_audit_ab_test_results.md`

### 1.2 å£å¾„åå·®ä¸ä¿®å¤çŠ¶æ€ï¼ˆä»¥ä»£ç /DB ä¸ºå‡†ï¼‰

âœ… å·²ä¿®å¤ï¼ˆå®ŒæˆéªŒæ”¶ï¼‰

- `GET /reports/{report_id}`ï¼šDB schema ä¸º `reports.id`ï¼Œä»£ç å·²ç»Ÿä¸€æŒ‰ `id` æŸ¥è¯¢ï¼ˆä¿ç•™è·¯ç”±å‚æ•°å `report_id`ï¼Œé¿å… breaking changeï¼‰ã€‚
- `report_jobs` çŠ¶æ€ï¼š`supabase/schema.sql` é»˜è®¤ `queued`ï¼›`report_worker` å·²å…¼å®¹æ‹‰å– `queued|pending` å¹¶æ›´æ–°çŠ¶æ€æœºï¼ˆ`queuedâ†’runningâ†’done/failed`ï¼‰ã€‚
- `report_jobs` é”å­—æ®µï¼šå·²å…·å¤‡å¹¶åœ¨ worker ä¸­å†™å…¥ï¼ˆ`locked_at/locked_by/attempt_count/last_error/report_id` ç­‰ï¼‰ã€‚
- `question_attempts/question_steps`ï¼šäº‹å®è¡¨å·²å­˜åœ¨ï¼Œ`facts_worker` å·²æŒç»­å†™å…¥ï¼ˆç”¨äºæŠ¥å‘Šç‰¹å¾å±‚ä¸è¿‡ç¨‹è¯Šæ–­ï¼‰ã€‚

è¯æ®ï¼ˆè¿è¡Œæ€ç¡®è®¤ï¼‰

- è¡¨/å­—æ®µå­˜åœ¨æ€§ï¼ˆPostgREST å£å¾„ï¼Œä¸ä¾èµ–ç›´è¿ Postgresï¼‰ï¼š`python3 scripts/verify_supabase_tables_rest.py`
- report_jobs é”/çŠ¶æ€æµè½¬ï¼šåœ¨ Reports é¡µç‚¹ä¸€æ¬¡â€œç”ŸæˆæŠ¥å‘Šï¼ˆæœ€è¿‘ä¸€æ¬¡ï¼‰â€ï¼Œå¯è§‚å¯Ÿ `queuedâ†’runningâ†’done`ï¼Œå¹¶è½åº“ `report_id`

ğŸ”„ ä»éœ€æ¨è¿›ï¼ˆç¯å¢ƒå‹éªŒæ”¶ï¼‰

- WSâ€‘Aï¼šç”Ÿäº§ç­‰ä»·å¤æµ‹å·²åœ¨æœ¬åœ°ä»¥ worker=2 è·‘å®Œå¹¶ç•™è¯æ®ï¼ˆè§ `docs/reports/a4_prod_equiv_worker2_summary_20260104.md`ï¼‰ã€‚åç»­ä»éœ€è¡¥ï¼š
  - worker=1 vs worker=4 çš„æ•æ„Ÿæ€§å¯¹æ¯”ï¼ˆç”¨äºæ‰©ç¼©å®¹é˜ˆå€¼ï¼‰
  - è¿ç§»åˆ°ç”Ÿäº§å¯¹è±¡å­˜å‚¨ï¼ˆArk/å›½å†…ï¼‰åçš„å¤æµ‹ï¼ˆé¿å… Supabase Storage å¹¶å‘æ³¢åŠ¨å½±å“ç»“è®ºï¼‰

### 1.3 æ‰§è¡ŒçŠ¶æ€å¿«ç…§ï¼ˆæ»šåŠ¨æ›´æ–°ï¼Œé¿å…â€œæˆ‘æ€»ä¼šå¿˜â€ï¼‰

> è¯´æ˜ï¼šè¿™é‡Œæ˜¯â€œå”¯ä¸€çœŸç›¸æºâ€çš„è¿›åº¦é¢æ¿ï¼›æ–°å¢éœ€æ±‚/ä»»åŠ¡å¿…é¡»å…ˆè½åˆ°æœ¬æ–‡ä»¶ä¸ Backlogï¼Œå†å¼€å§‹åŠ¨æ‰‹åšã€‚

- âœ… WSâ€‘A å·²å®Œæˆï¼š
  - Aâ€‘1 é»˜è®¤ç­–ç•¥ï¼š`GRADE_IMAGE_INPUT_VARIANT=url`ï¼ˆå¿«è·¯å¾„å›ºå®šï¼Œå…ˆä¿ä½“éªŒï¼‰
  - Aâ€‘2 æŒç»­å®¡è®¡ï¼š`bench_grade_variants_async.py` + å¤šä»½ `docs/reports/grade_perf_*` ç•™æ¡£
  - Aâ€‘4 ç”Ÿäº§ç­‰ä»·ï¼ˆworker=2ï¼‰å¤æµ‹ä¸ç•™è¯æ®ï¼ˆå£å¾„æ‹†åˆ† `queue_wait_ms` vs `worker_elapsed_ms`ï¼‰
    - è¯æ®æ±‡æ€»ï¼š`docs/reports/a4_prod_equiv_worker2_summary_20260104.md`
    - æ˜ç»†ï¼ˆç©ºé˜Ÿåˆ—èµ·æ­¥ï¼‰ï¼š`docs/reports/a4_w2_burst20_p3_empty.md`
    - æ˜ç»†ï¼ˆæ¨¡æ‹Ÿå°ç§¯å‹ï¼‰ï¼š`docs/reports/a4_w2_preload4_burst10_p3_backlog.md`
  - Aâ€‘7.1 Layer 3 å¤æ ¸å¡ï¼ˆåç«¯ï¼‰ï¼š`review_pending â†’ review_ready/review_failed` å¼‚æ­¥æ›´æ–° `job.question_cards`
  - Aâ€‘7.2 Layer 1/2ï¼ˆåç«¯èƒ½åŠ›å·²å…·å¤‡ï¼‰ï¼š`question_cards` çš„å ä½/åˆ¤å®šå­—æ®µä¸ `answer_state=blank` å£å¾„å·²è½åœ°ï¼ˆDemo å¯é€‰æ‹©éšè—ï¼‰
- ğŸ”„ WSâ€‘A å¾…è¡¥ï¼š
  - Aâ€‘4.2 worker å¹¶å‘æ•æ„Ÿæ€§ï¼šæŒ‰ä½ çš„å†³ç­–â€œå…ˆè·‘ 2ï¼Œå›å¤´å†å¯¹æ¯” 1/4â€ï¼Œè¡¥ä¸€è½®å¯¹æ¯”ç”¨äºæŒ‡å¯¼æ‰©ç¼©å®¹é˜ˆå€¼ï¼ˆå»ºè®® burst=10ã€3é¡µ/æ¬¡å³å¯çœ‹è¶‹åŠ¿ï¼‰
- âœ… WSâ€‘C å·²å®Œæˆï¼š
  - Câ€‘4 `GET /api/v1/reports/eligibility` å·²å®ç°ï¼ˆæƒå¨ç»Ÿè®¡å£å¾„ï¼šåŸºäº `submissions`ï¼Œä¸ä¾èµ– `/mistakes`ï¼‰
  - Câ€‘5 `GET /api/v1/submissions` å·²å®ç°ï¼ˆHome Recent Activity / History List æ•°æ®æºï¼‰
  - Câ€‘6 `GET /api/v1/submissions/{submission_id}` å·²å®ç°ï¼ˆHistory Detail æ–¹æ¡ˆBï¼šå¿«ç…§è¯¦æƒ…ç§’å¼€ï¼‰
  - Câ€‘2 facts_worker å·²å®ç°å¹¶å·²åœ¨ `/grade` æµç¨‹å…¥é˜Ÿï¼ˆ`question_attempts/question_steps` å›å¡«ï¼›report_worker å«ç¼ºçœå›é€€è·¯å¾„ï¼‰
- âœ… WSâ€‘B å·²å®Œæˆï¼ˆå¯ä¸¢æ•°æ®ä¹Ÿè¦å£å¾„ä¸€è‡´ï¼‰ï¼š
  - Bâ€‘1 Schema ç°åœºå¯¹é½ï¼š`report_jobs` é”å­—æ®µ + `question_attempts/question_steps` å·²åœ¨å½“å‰ Supabase é¡¹ç›®å¯ç”¨ï¼ˆå·²ç”¨ `scripts/verify_supabase_tables_rest.py` éªŒè¯ï¼‰ã€‚
  - Bâ€‘2 RLS/æƒé™æ²»ç†ï¼šworker è¿è¡Œç¯å¢ƒå¯ç”¨ `SUPABASE_SERVICE_ROLE_KEY` ä¸” `WORKER_REQUIRE_SERVICE_ROLE=1`ï¼Œå¯ç¨³å®š UPDATE `report_jobs`ï¼ˆé”/çŠ¶æ€æµè½¬/è½åº“ report_idï¼‰ã€‚
- âœ… WSâ€‘C å·²å®Œæˆï¼ˆè¿è¡Œæ€ç¡®è®¤ï¼‰ï¼š
  - Câ€‘1 report_worker ç¨³å®šåŒ–ï¼š`queuedâ†’runningâ†’done/failed` å¯è§‚æµ‹ï¼Œé”å­—æ®µå†™å…¥ä¸ report_id è½åº“ç”Ÿæ•ˆã€‚
- ğŸ§­ æ–°å¢ P0ï¼ˆæœ¬æ¬¡æ–°å¢ï¼‰ï¼šAâ€‘8 å†å²é”™é¢˜å¤ä¹ ï¼ˆChat Rehydrateï¼Œè§ä¸‹ï¼‰
- â³ WSâ€‘Dï¼ˆP2ï¼šä¸Šçº¿å‰å¿…é¡»åšï¼‰ï¼šVKE/K8s éƒ¨ç½²ä¸æŒ‰éœ€æ‰©ç¼©å®¹ï¼ˆæ–¹æ¡ˆå·²å®šï¼Œå°šæœªè½åœ° IaC/YAMLï¼‰

### 1.4 å¤–éƒ¨â€œä½“æ£€æŠ¥å‘Šâ€å£å¾„æ ¡å¯¹ï¼ˆä»¥ä»£ç ä¸ºå‡†ï¼‰

> ç»“è®ºï¼šå¤–éƒ¨æ€»ç»“å¯å‚è€ƒï¼Œä½†éƒ¨åˆ†å£å¾„ä¼šè¯¯å¯¼åä½œï¼ˆå°¤å…¶æ˜¯ SSE å®¢æˆ·ç«¯å®ç°ä¸â€œç«¯ç‚¹æ•°é‡â€ï¼‰ã€‚ç»Ÿä¸€ä»¥æœ¬ä»“åº“ä»£ç ä¸å¥‘çº¦ä¸ºå‡†ã€‚

- ä»£ç æ ¸å¯¹æŠ¥å‘Šï¼š`docs/reports/healthcheck_report_code_alignment_20260103.md`
- éœ€è¦ç‰¹åˆ«æ³¨æ„çš„å‡ºå…¥ç‚¹ï¼ˆé¿å…åç»­è¯¯è¯»ï¼‰ï¼š
  - **API ç«¯ç‚¹æ•°é‡**ä¸æ˜¯ç¨³å®šæŒ‡æ ‡ï¼šå½“å‰ `/api/v1/*` ä¸º 20 æ¡ unique pathsï¼ˆä»¥ `homework_agent/API_CONTRACT.md` ä¸ºå‡†ï¼Œä¸å†™å›ºå®šæ•°å­—ï¼‰ã€‚
  - **SSE å®¢æˆ·ç«¯å®ç°**ï¼šåç«¯æ”¯æŒ `Last-Event-Id`ï¼ˆæ¢å¤ session + æœ€å¤šé‡æ”¾ 3 æ¡ assistantï¼‰ï¼Œä½†å½“å‰ demo å‰ç«¯ç”¨ `fetch + ReadableStream` è§£æ SSEï¼Œå°šæœªæ¥å…¥ `Last-Event-Id` æ–­çº¿ç»­æ¥ã€‚
  - **ç±»å‹å£å¾„**ï¼šæ ¸å¿ƒå­—æ®µå·²å¯¹é½ï¼Œä½†å‰ç«¯ä»å­˜åœ¨å°‘é‡ `any` ä½œä¸ºè¿‡æ¸¡ï¼ˆä¸åº”å®£ç§°â€œå®Œå…¨æ—  anyâ€ï¼‰ã€‚

## 2) å·¥ä½œæµæ‹†åˆ†ï¼ˆWorkstreamsï¼‰

### WSâ€‘Aï¼š/grade æ€§èƒ½ä¸è´¨é‡ï¼ˆArk ä½œä¸ºä¸»çº¿ï¼‰

**ç›®æ ‡**ï¼šæŠŠâ€œæ…¢â€æ‹†è§£ä¸ºç¡®å®šç“¶é¢ˆï¼›æŠŠâ€œå¿«ä½†ä¸ä¸¥è°¨â€æ”¹æˆâ€œå¯å®¡è®¡ + å¯æ§é™çº§â€ã€‚

#### Aâ€‘1 é€‰æ‹©é»˜è®¤å›¾ç‰‡è¾“å…¥ç­–ç•¥ï¼ˆåŸºäºç°æœ‰æ•°æ®ï¼‰

- å†³ç­–ï¼š**å½“å‰é»˜è®¤å›ºå®š `url`**ï¼ˆå…ˆæŠŠå¿«è·¯å¾„è·‘ç¨³ + æå‡å¯è§£é‡Šæ€§ï¼‰ï¼›`proxy` å¾…é—­ç¯ä¿®å¤åå†åšæœ€å°éªŒè¯å¹¶è€ƒè™‘åˆ‡é»˜è®¤ã€‚
- å¤‡æ³¨ï¼š`data_url_*` ä»…ç”¨äºâ€œå°‘é‡å¤æ ¸/äº‰è®® recheckâ€ï¼Œä¸ä½œä¸ºé»˜è®¤å…¨é‡ç­–ç•¥ã€‚
- éªŒæ”¶ï¼š
  - `/grade` P95ï¼ˆåŒæ­¥åœºæ™¯ï¼‰æ˜¾è‘—ä¸‹é™æˆ–è‡³å°‘ç“¶é¢ˆå¯è§£é‡Šï¼›
  - `needs_review_rate` å¯æ§ä¸”æœ‰åŸå› å­—æ®µï¼›
  - äº§ç”Ÿ `response_id` ä¸”å¯å›æŸ¥ã€‚

#### Aâ€‘2 â€œæ…¢åˆ°åº•æ…¢åœ¨å“ªâ€æŒç»­å®¡è®¡ï¼ˆæ—¥å¿—é©±åŠ¨ï¼‰

- äº¤ä»˜ç‰©ï¼š
  - å›ºåŒ–å…³é”®æ—¥å¿—äº‹ä»¶ä¸å­—æ®µï¼š`grade_total_duration_ms`ã€`preprocess_*`ã€`compress_*`ã€`llm_*`ã€`submission_persist_*`ã€‚
  - å¯¹æ¯”ä¸‰ç»„ï¼š`Ark URL æ‹‰å›¾ vs base64 å°‘é‡å¤æ ¸ vs é¢„ç”Ÿæˆ proxy`ã€‚
    - æ—¥å¸¸è¿­ä»£ï¼šæ¯ä¸ª variant å…ˆè·‘ **N=5**ï¼Œè¾“å‡º `p50 + max + å¤±è´¥ç‡/needs_reviewç‡`ï¼ˆæ›´å¿«ã€æ›´çœé’±ï¼Œç”¨äºåˆ¤æ–­æ–¹å‘ï¼‰ã€‚
    - å†³ç­–/éªŒæ”¶ï¼šå†è¡¥ä¸€è½® **N=5**ï¼ˆä¸åŒæ—¶é—´æ®µ/æ¸…ç©ºé˜Ÿåˆ—æˆ–éš”ç¦»å‰ç¼€åï¼‰ï¼Œä¸¤è½®åˆå¹¶è§†ä½œ **â‰ˆN=10**ï¼Œå†çœ‹ `p50/p95` ä»¥å‡å°‘æŠ½æ ·å¶ç„¶æ€§ã€‚
  - å›ºåŒ–å¯å¤è·‘è„šæœ¬ï¼š`scripts/bench_grade_variants_async.py`ï¼ˆè¾“å‡º `docs/reports/grade_perf_variants_*.md/.json`ï¼‰ã€‚
- å·²è·‘ N=10ï¼ˆIMG_0699ï¼‰ï¼š`docs/reports/grade_perf_variants_qindex_only_n10_img0699_20260101.md`
- æœ€æ–°å¿«è·¯å¾„åŸºçº¿ï¼ˆURL-only + qindex_onlyï¼‰ï¼š`docs/reports/grade_perf_url_n3_fast_finalize_12000_20260102.md`
- å¤ç›˜æ‘˜è¦ï¼ˆå«å…³é”®å®ç°ç­–ç•¥ï¼‰ï¼š`docs/reports/grade_perf_fast_path_summary_20260102.md`
- éªŒæ”¶ï¼šæ¯æ¬¡ä¼˜åŒ–å‰åéƒ½æœ‰â€œå¯å¯¹æ¯”çš„é‡åŒ–è¯æ®â€ï¼Œä¸ä¼šå‡­æ„Ÿè§‰æ¢ç­–ç•¥ã€‚

#### Aâ€‘3 image_process çš„æ”¶ç›ŠéªŒè¯ï¼ˆä¸åš A/B ä¹Ÿè¦å¯å¤ç°ï¼‰

- äº¤ä»˜ç‰©ï¼š
  - åœ¨ç›¸åŒè¾“å…¥/ç›¸åŒ `GRADE_IMAGE_INPUT_VARIANT` ä¸‹ï¼Œè·‘ `ARK_IMAGE_PROCESS_ENABLED=0/1` ä¸¤ç»„ï¼š
    - æ—¥å¸¸è¿­ä»£ï¼šæ¯ç»„å…ˆè·‘ **N=5**
    - å†³ç­–/éªŒæ”¶ï¼šä¸¤è½® N=5 åˆå¹¶ï¼ˆâ‰ˆN=10ï¼‰
  - è¾“å‡ºï¼šé€Ÿåº¦ï¼ˆæ€»è€—æ—¶ + åˆ†é¡¹ï¼‰ä¸è´¨é‡ï¼ˆwrong_items ç¨³å®šæ€§/äº’æ–¥ç‡/uncertainï¼‰å¯¹æ¯”ã€‚
- éªŒæ”¶ï¼šæ˜ç¡®â€œå“ªäº›é¢˜å‹/å“ªäº›åœºæ™¯å¼€å¯æœ‰æ•ˆâ€ï¼Œå†å†³å®šæ˜¯å¦æ‰©å¤§èŒƒå›´ã€‚

è¡¥å……ï¼šå½“å‰å¿«è·¯å¾„é»˜è®¤ä¸å¯ç”¨ `image_process`ï¼ˆé¿å… deep-vision åœ¨å¿«è·¯å¾„ä¸­é•¿æ—¶é—´æ€è€ƒ/æ‹‰å›¾ï¼‰ï¼›ä»…å½“å­˜åœ¨æ˜ç¡®å›¾å½¢è¯æ®ï¼ˆfigure slicesï¼‰æ—¶å¯ç”¨ã€‚

#### Aâ€‘4 æœ¬è½®æ–°å¢ï¼šå¿«è·¯å¾„é¢„å¤„ç†é™çº§ + å®éªŒéš”ç¦» + éªŒæ”¶é˜ˆå€¼ï¼ˆæ¥è‡ªç¬¬äºŒè½®å®æµ‹ç»“è®ºï¼‰

> è¯´æ˜ï¼šä»¥ä¸‹æ˜¯åŸºäºä¸¤è½®å®æµ‹ï¼ˆDemo + benchï¼‰ä¸åŒäº‹å¤æ ¸å½¢æˆçš„â€œç«‹å³å¯è½åœ°â€ä¼˜å…ˆçº§å»ºè®®ï¼›è¯æ®ç•™æ¡£è§ï¼š
> - `docs/reports/demo_ui2_run_20260101_133600.md`
> - `docs/reports/grade_perf_root_cause_findings_20260101.md`
> - `docs/reports/grade_perf_variants_full_after_fix_20260101.md`
> - `docs/reports/grade_perf_variants_off_variantprop_20260101.md`

- P0ï¼ˆç°åœ¨å°±åšï¼Œç›´æ¥æ”¹å–„ä½“éªŒï¼‰
  - é»˜è®¤æŠŠ grade å¿«è·¯å¾„è®¾ä¸º `AUTONOMOUS_PREPROCESS_MODE=qindex_only`ï¼ˆä»…å¤ç”¨ qindex ç¼“å­˜åˆ‡ç‰‡ï¼›æœªå‘½ä¸­åˆ™è·³è¿‡ï¼‰ï¼ŒæŠŠ VLM locator/åˆ‡ç‰‡ç§»å‡ºå¿«è·¯å¾„ï¼Œä»…åœ¨â€œè§†è§‰é£é™©/å¤æ ¸â€æ—¶è§¦å‘ã€‚
  - è‹¥ qindex ç¼“å­˜é•¿æœŸæœªå‘½ä¸­/worker æœªå¯ç”¨ï¼Œä¸´æ—¶å›é€€åˆ° `AUTONOMOUS_PREPROCESS_MODE=off`ï¼ˆé¿å…è¢«é¢„å¤„ç†æ‹–æ…¢å¿«è·¯å¾„ï¼‰ã€‚
  - â€œæ¸…é™¤æµ‹è¯•å¹²æ‰°â€è½åœ°ä¸ºéš”ç¦»ç­–ç•¥ï¼šä¼˜å…ˆç”¨æ–°çš„ `CACHE_PREFIX` / `DEMO_USER_ID` åšå®éªŒéš”ç¦»ï¼ˆä¼˜å…ˆçº§é«˜äº `redis-cli FLUSHDB`ï¼‰ã€‚
- P1ï¼ˆè®©å¯¹æ¯”ç»“è®ºæ›´å¯ä¿¡ã€è®©ç­–ç•¥æ›´å¯è¿è¥ï¼‰
  - ç»Ÿè®¡ç­–ç•¥ï¼šæ—¥å¸¸è¿­ä»£ç”¨ **N=5**ï¼ˆçœ‹ `p50 + max + å¤±è´¥ç‡`ï¼‰ï¼Œéœ€è¦åšé»˜è®¤ç­–ç•¥/éªŒæ”¶ç»“è®ºæ—¶å†è¡¥ä¸€è½® N=5ï¼ˆåˆå¹¶â‰ˆN=10 åçœ‹ p50/p95ï¼‰ã€‚
  - è®© `proxy` å˜ä½“åå‰¯å…¶å®ï¼šå½“å‰æ›´å â€œprefer_proxyâ€ï¼Œç¼ºå°‘ç¨³å®šç”Ÿæˆ proxy èµ„äº§çš„æœºåˆ¶ï¼Œå¯¼è‡´å¯¹æ¯”å£å¾„ä¸çº¯ï¼›éœ€è¡¥é½â€œç”Ÿæˆ/å›å†™/å¤ç”¨ proxy_page_image_urlsâ€çš„é—­ç¯åå†å®šé»˜è®¤ç­–ç•¥ã€‚
  - å¢åŠ â€œå•æ¬¡ä½œä¸šæŠ¥å‘Šâ€ï¼šç»™ `/reports` å¢åŠ  `submission_id` æ¨¡å¼ï¼ˆDemo å±•ç¤ºæ›´ç¬¦åˆç”¨æˆ·é¢„æœŸï¼›å‘¨æœŸæ€§æŠ¥å‘Š `window_days` ç»§ç»­ä¿ç•™ï¼‰ã€‚
- P2ï¼ˆå·¥ç¨‹ä¸€è‡´æ€§/æ–‡æ¡£ï¼‰
  - `homework_agent/utils/settings.py` ä¸­ `REPORT_NARRATIVE_ENABLED` çš„æ³¨é‡Šä¸é»˜è®¤å€¼ä¸ä¸€è‡´ï¼ˆæ³¨é‡Šå†™â€œkeep off by defaultâ€ï¼Œä½† `default=True`ï¼‰ï¼›éœ€ç»Ÿä¸€å£å¾„ï¼Œé¿å…è¯¯è¯»ã€‚

- å·¥å…·è„šæœ¬ï¼ˆAâ€‘4 ç”Ÿäº§ç­‰ä»·å¤æµ‹ï¼‰
  - `python3 scripts/bench_a4_load_async.py`ï¼ˆuploadsâ†’gradeâ†’jobsï¼›æ”¯æŒ burstã€å¤šé¡µã€preload æ¨¡æ‹Ÿå°ç§¯å‹ï¼›è¾“å‡ºåˆ° `docs/reports/a4_*.{json,md}`ï¼‰

- éªŒæ”¶å£å¾„ï¼ˆAâ€‘4ï¼šæ›´é‡â€œç¨³å®š + å…ˆå¯ç”¨â€ï¼Œä¸å†ç”¨æ•´ä»½ TTD ç¡¬å‹ï¼‰
  - **å†…éƒ¨å¯ç”¨æ€§ï¼ˆä¸å«æ’é˜Ÿï¼‰**ï¼šjob å¯åŠ¨åï¼Œç¬¬ 1 é¡µå¯ç”¨æ—¶é—´ `TTV(page1_after_start)=ttv_first_page_ms-queue_wait_ms`
    - ç›®æ ‡ï¼šp50 â‰¤ 180sã€p95 â‰¤ 240sï¼ˆä½ ç»™çš„ä½“æ„Ÿç›®æ ‡æ˜¯ 2â€“3 åˆ†é’Ÿå†…èƒ½å¼€å§‹çœ‹/èƒ½é—®ï¼‰
  - **é˜Ÿåˆ—å¯æ§ï¼ˆæ’é˜Ÿï¼‰**ï¼šè®°å½• `queue_wait_ms` åˆ†å¸ƒï¼ˆp50/p95/maxï¼‰ï¼Œå¹¶ç”¨åˆ°è¾¾ç‡Ã—æœåŠ¡æ—¶é—´æ¨å¯¼â€œæœ€ä½å¹¶å‘ workerâ€ä¸æ‰©ç¼©å®¹é˜ˆå€¼
    - æœ¬è½®åªè·‘ worker=2 çš„åŸºçº¿ï¼ˆä½ å·²ç¡®è®¤â€œå…ˆæµ‹ 2ï¼Œå›å¤´å†å¯¹æ¯” 1/4â€ï¼‰
  - **ç¨³å®šæ€§**ï¼šåŒºåˆ†â€œjob ä»åœ¨è·‘ï¼ˆtimeoutï¼‰â€ vs â€œçœŸå® failedâ€ï¼Œå¹¶å•ç‹¬ç»Ÿè®¡ä¸Šä¼ ä¾§ 5xxï¼ˆå½“å‰ Supabase Storage å¹¶å‘ä¸‹å¯èƒ½æ³¢åŠ¨ï¼›ç”Ÿäº§è¿ç§»åå†å®šç¡¬æŒ‡æ ‡ï¼‰

#### Aâ€‘5 è§†è§‰é¢˜éªŒè¯ï¼ˆå‡ ä½•/å‡½æ•°å›¾åƒ/å¤æ‚ç¤ºæ„å›¾ï¼‰

> ç›®æ ‡ï¼šåœ¨å¿«è·¯å¾„å›ºå®šåï¼Œç”¨çœŸå®è§†è§‰é¢˜æ ·æœ¬éªŒè¯â€œä½•æ—¶å¿…é¡»åˆ‡åˆ°è§†è§‰è¯æ®è·¯å¾„â€ï¼Œå¹¶æŠŠé—¨æ§›å›ºåŒ–ä¸ºå¯è§£é‡Šçš„è§„åˆ™ï¼ˆå®å¯ `uncertain` ä¹Ÿä¸è¯¯åˆ¤ä¸º `correct`ï¼‰ã€‚

- è¾“å…¥ï¼šè‡³å°‘ 2 å¼ çœŸå®æ ·æœ¬ï¼ˆä¼˜å…ˆï¼šå‡ ä½• 1 å¼ ã€å‡½æ•°åæ ‡ç³» 1 å¼ ï¼‰ã€‚æœ¬è½®å·²ç”¨ 2 å¼ å‡ ä½•æ ·æœ¬å®ŒæˆéªŒè¯ï¼ˆå‡½æ•°å›¾åƒå¾…è¡¥æ ·å¤æ ¸ï¼‰ã€‚
- ç»Ÿè®¡ï¼šåŒå›¾é‡å¤ **N=5**ï¼ˆä¸å¿«è·¯å¾„éªŒæ”¶å£å¾„å¯¹é½ï¼‰ï¼Œè®°å½• `p50/p95` + å¤±è´¥ç‡/`needs_review_rate`ã€‚
- å¯¹æ¯”ï¼š
  - `AUTONOMOUS_PREPROCESS_MODE=qindex_only`ï¼ˆé»˜è®¤å¿«è·¯å¾„ï¼›éªŒè¯æ˜¯å¦éœ€è¦è§¦å‘â€œè½»é‡è§†è§‰è·¯å¾„â€ï¼‰
  - `AUTONOMOUS_PREPROCESS_MODE=full`ï¼ˆè§†è§‰è¯æ®é“¾ä¸Šé™åŸºçº¿ï¼›ä¸ä½œä¸ºé»˜è®¤ï¼‰
- äº§ç‰©ï¼š
  - ç»Ÿä¸€æ±‡æ€»ï¼š`docs/reports/grade_perf_visual_validation_20260102.md`
  - æ˜ç»†ï¼ˆN=5ï¼‰ï¼š`docs/reports/grade_perf_visual_img0699_qindex_only_url_n5_20260102.md`ã€`docs/reports/grade_perf_visual_img0699_full_url_n5_20260102.md`ã€`docs/reports/grade_perf_visual_img1100_qindex_only_url_n5_20260102.md`ã€`docs/reports/grade_perf_visual_img1100_full_url_n5_20260102.md`
- å›ºåŒ–ç»“è®ºï¼ˆè§¦å‘è§„åˆ™ï¼Œå·²è½åœ°å®ç°ï¼‰ï¼š
  - é»˜è®¤å¿«è·¯å¾„ä»æ˜¯ `qindex_only + url`ï¼Œä½†å½“å‘½ä¸­ `visual_risk`ï¼ˆOCR å…³é”®å­—ï¼‰æˆ–å­˜åœ¨ slices æ—¶ï¼Œåˆ‡æ¢åˆ°â€œå¸¦å›¾ + image_processâ€ï¼ˆå®å¯ä¸ç¡®å®šä¹Ÿä¸è¯¯åˆ¤ï¼‰ã€‚
  - `full` ä»…ç”¨äºâ€œç¦»çº¿å¤æ ¸/æ­£ç¡®æ€§ä¸Šé™â€ï¼Œé¿å…æŠŠ ~70â€“100s çš„é¢„å¤„ç†æˆæœ¬å¸¦å…¥é»˜è®¤å¿«è·¯å¾„ã€‚

#### Aâ€‘6 å¤šé¡µä½œä¸šâ€œé€é¡µå¯ç”¨â€ä½“éªŒï¼ˆæ–¹æ¡ˆ Aï¼šå• job + partial è¾“å‡ºï¼‰

> èƒŒæ™¯ï¼šå¤šé¡µä½œä¸šè‹¥â€œå¿…é¡»ç­‰å…¨é‡ç»“æŸæ‰å‡ºç»“æœâ€ï¼Œç”¨æˆ·ä½“æ„Ÿä¼šå¾ˆå·®ï¼›è€Œè±†åŒ… App è™½å¿«ä½†ä¸ä¸¥è°¨ï¼Œæˆ‘ä»¬çš„å·®å¼‚åŒ–æ˜¯â€œå¯è§£é‡Š + å¯æ§ä¸ç¡®å®šâ€ï¼Œå› æ­¤æ›´éœ€è¦æŠŠç­‰å¾…å˜æˆâ€œé€é¡µå¯ç”¨ + å¯é€‰è¿›å…¥è¾…å¯¼â€ã€‚
>
> åŸåˆ™ï¼š**ä»ç„¶æ˜¯ 1 ä¸ª submission / 1 ä¸ª grade job**ï¼Œåªæ˜¯è®© job åœ¨ `running` æœŸé—´æŒç»­æš´éœ²â€œå·²å®Œæˆé¡µâ€çš„æœ€å°æ‘˜è¦ï¼›è¾…å¯¼ï¼ˆ/chatï¼‰åªåŸºäºå·²å®Œæˆé¡µçš„è¯æ®å›ç­”ã€‚

- å‰ç«¯ä½“éªŒç›®æ ‡ï¼ˆDemo UI 2.0ï¼‰
  - ä¸Šä¼  N å¼ å›¾åç«‹å³æ˜¾ç¤º `1/N..N/N` é¡µå¡ï¼ˆç¼©ç•¥å›¾/é¡µå·ï¼‰ã€‚
  - ç¬¬ 1 é¡µç»“æœå°±ç»ªåç«‹å³æ¸²æŸ“â€œç¬¬ 1 é¡µæ‘˜è¦â€ï¼ˆé”™é¢˜æ•°/å¾…ç¡®è®¤æ•°/needs_reviewï¼‰ï¼Œä¸ç­‰å¾…åç»­é¡µå®Œæˆã€‚
  - æ¯é¡µå¡ç‰‡æä¾› **â€œè¿›å…¥è¾…å¯¼ï¼ˆæœ¬é¡µï¼‰â€**æŒ‰é’®ï¼ˆç”¨æˆ·å¯é€‰è¿›å…¥ï¼Œä¸å¼ºåˆ¶ï¼‰ã€‚
  - å…¨éƒ¨é¡µå®Œæˆåå†å±•ç¤ºâ€œæœ¬æ¬¡ submission æ±‡æ€»â€ï¼ˆæ€»é”™é¢˜/å¾…ç¡®è®¤/å¸¸è§é”™è¯¯ç±»å‹/çŸ¥è¯†ç‚¹æ‘˜è¦ï¼‰ä¸â€œç”Ÿæˆå­¦ä¸šæŠ¥å‘Šâ€å…¥å£ã€‚

- åç«¯å¥‘çº¦ä¸æ•°æ®æ¥æºï¼ˆæœ€å°æ”¹åŠ¨ï¼‰
  - `/jobs/{job_id}`ï¼ˆRedis job çŠ¶æ€ï¼‰åœ¨ `running` æ—¶å…è®¸è¿”å›ï¼š
    - `total_pages`ï¼ˆintï¼‰ã€`done_pages`ï¼ˆintï¼‰
    - `page_summaries`ï¼ˆlistï¼ŒæŒ‰ `page_index` é€’å¢ï¼›æ¯é¡¹åŒ…å«ï¼š`page_index(0-based), wrong_count, uncertain_count, needs_review, warnings(optional)`ï¼‰
      - å¯é€‰ï¼ˆDemo 2.0 ä¾¿æ·ï¼‰ï¼š`wrong_item_ids`ï¼ˆç”¨äºâ€œä¸€é”®è¿›å…¥è¾…å¯¼æœ¬é¡µâ€ï¼Œä¸è¦æ±‚ç¨³å®šå­˜åœ¨/ä¸è¿›å…¥æ­£å¼å¥‘çº¦ï¼‰
  - `qbank:{session_id}` / `GET /session/{session_id}/qbank`ï¼š
    - `meta.pages_total/pages_done`ï¼ˆç”¨äº UI ä¸ chat è¾¹ç•Œæç¤ºï¼‰
    - é€é¡µè¿½åŠ çš„ `questions`/`wrong_items` æˆ–ç­‰ä»·ç»“æ„ï¼ˆè‡³å°‘ä¿è¯â€œå·²å®Œæˆé¡µâ€çš„è¯æ®é“¾å¯ç”¨äº chatï¼‰ã€‚

- å…³é”®çº¦æŸï¼ˆç¨³å®šæ€§/æˆæœ¬ï¼‰
  - chat ä¸ grade è§£è€¦ï¼šç”¨æˆ·åœ¨ grade è¿›è¡Œä¸­æé—®ï¼Œä¸åº”é˜»å¡ grade jobï¼›ä½†å¿…é¡»åœ¨ UI æç¤ºâ€œå½“å‰ä»…åŸºäºå·²å®Œæˆé¡µå›ç­”â€ã€‚
  - æˆæœ¬æŠ¤æ ï¼šå…è®¸å¹¶å‘ï¼ˆgrade worker + chat LLMï¼‰ä½†è¦æœ‰å¹¶å‘/é€Ÿç‡æ§åˆ¶ï¼Œé¿å… provider é™æµå¯¼è‡´å¤±è´¥ç‡ä¸Šå‡ã€‚
  - è¾“å‡ºä½“ç§¯ï¼š`page_summaries` åªæ”¾æ‘˜è¦ï¼Œé¿å…æŠŠå®Œæ•´é”™é¢˜/è¯æ®å¡è¿› job payloadï¼ˆè¯¦ç»†æ•°æ®ä»ä»¥ `qbank`/DB ä¸ºå‡†ï¼‰ã€‚

- éªŒæ”¶
  - å¤šé¡µä½œä¸šï¼šç¬¬ 1 é¡µç»“æœå‡ºç°åï¼ŒUI åœ¨ä¸‹ä¸€æ¬¡ polling å†…å±•ç¤ºè¯¥é¡µæ‘˜è¦ï¼ˆæ— éœ€ç­‰å…¨é‡å®Œæˆï¼‰ã€‚
  - chatï¼šåœ¨åªå®Œæˆ X/N æ—¶æé—®ï¼Œå›å¤å¿…é¡»æ˜¾å¼æ ‡æ³¨â€œå½“å‰åŸºäºå·²å®Œæˆé¡µï¼ˆ1..Xï¼‰â€ï¼Œä¸”ä¸å¼•ç”¨æœªå®Œæˆé¡µå†…å®¹ã€‚
  - å…¨é‡å®Œæˆåï¼Œæœ€ç»ˆ grade ç»“æœä¸ç°åœ¨çš„â€œä¸€æ¬¡æ€§æ±‡æ€»â€å£å¾„ä¸€è‡´ï¼ˆåªæ˜¯æ›´æ—©å¯è§éƒ¨åˆ†ç»“æœï¼‰ã€‚

- å½“å‰å®ç°ï¼ˆå·²è½åœ°ï¼‰
  - Workerï¼š`homework_agent/workers/grade_worker.py`ï¼ˆé€é¡µæ‰§è¡Œ + job partial æ›´æ–° + qbank/mistakes å¢é‡å†™å…¥ï¼‰
  - Demo UIï¼š`homework_agent/demo_ui.py`ï¼ˆé€é¡µè¿›åº¦å±•ç¤º + é€‰æ‹©é¡µè¿›å…¥è¾…å¯¼ï¼‰
  - Chatï¼š`homework_agent/api/_chat_stages.py`ï¼ˆæ”¯æŒ `context_item_ids` ç»‘å®š focus é¢˜å·ï¼›ä¼˜å…ˆæŒ‰é¡µæ¶ˆæ­§ï¼‰
  - Tutor LLMï¼š`homework_agent/services/llm.py`ï¼ˆæœªå®Œæˆé¡µå¼ºåˆ¶å…è´£å£°æ˜ï¼šä»…åŸºäºå·²å®Œæˆé¡µå›ç­”ï¼‰

#### Aâ€‘7 ä¸‰å±‚æ¸è¿›æŠ«éœ²ï¼ˆQuestion Cardsï¼šå ä½â†’åˆ¤å®šâ†’å¤æ ¸ï¼‰

> ç›®æ ‡ï¼šæŠŠâ€œç­‰å¾…æ‰¹æ”¹â€ä»é»‘ç›’ç­‰å¾…å˜æˆ**ç§’çº§å¯è§ã€é€æ­¥å˜æ¸…æ™°ã€å¯ä¸­é€”äº¤äº’**çš„è¿‡ç¨‹ï¼›æ”¯æ’‘å‰ç«¯â€œå ä½å¡åˆ·å‡º + ç¿»è½¬åŠ¨ç”» + è¿½æ›´æ¨¡å¼â€ã€‚

- è®¾è®¡å¯¹é½æ–‡æ¡£ï¼ˆä¾›å‰åç«¯åˆ†å·¥ï¼‰ï¼š`docs/design_progressive_disclosure_question_cards.md`
- å½“å‰å†³ç­–ï¼ˆ2026â€‘01â€‘03 æ›´æ–°ï¼‰
  - **P0ï¼ˆå‰ç«¯éªŒæ”¶é˜»å¡ï¼‰åªéªŒæ”¶ Layer 3ã€Œå¤æ ¸å¡ã€**ï¼šæŠŠâ€œå°‘é‡é«˜é£é™©é¢˜â€åšæˆå¼‚æ­¥å¤æ ¸ï¼Œä¸é˜»å¡ grade å®Œæˆã€‚
  - Layer 1/2ï¼ˆå ä½/åˆ¤å®šå¡ï¼‰åç«¯å·²å…·å¤‡ï¼Œä½†**å‰ç«¯å¯å…ˆéšè—/ä¸å¼ºè°ƒ**ï¼ˆé¿å…æŠŠ Demo äº¤äº’å¤æ‚åº¦æ‹‰é«˜ï¼‰ï¼›åç»­å†å¯ç”¨â€œç¿»è½¬/è¿½æ›´â€åŠ¨æ•ˆå³å¯ã€‚

##### Aâ€‘7.1 Layer 3 å¤æ ¸å¡ï¼ˆP0ï¼šå‰ç«¯ç­‰éªŒæ”¶ï¼‰

- è§¦å‘è§„åˆ™ï¼ˆå¯è§£é‡Šã€ç¡®å®šæ€§ã€å¯å®¡è®¡ï¼‰
  - è¾“å…¥ï¼šæ¯é¢˜ `verdict` + `warnings` + `needs_review`ï¼ˆæˆ–ç­‰ä»·æç¤ºï¼‰+ è§†è§‰é£é™©ï¼ˆ`visual_risk`/`visual_risk_reasons` æ¨æ–­ï¼‰+ æ˜¯å¦ç©ºé¢˜ï¼ˆ`answer_state`ï¼‰
  - è¾“å‡ºï¼š`review_needed=true/false` + `review_reasons[]`ï¼ˆç”¨äº UI æ–‡æ¡ˆä¸å®¡è®¡ï¼‰
  - é»˜è®¤ç­–ç•¥ï¼šåªå¤æ ¸â€œè§†è§‰é£é™© + needs_review/uncertainâ€çš„å°‘é‡é¢˜ï¼ˆæ¯é¡µä¸Šé™ï¼Œé¿å…æˆæœ¬çˆ†ç‚¸ï¼‰
  - ä»£ç ä½ç½®ï¼š`homework_agent/core/review_cards_policy.py`ï¼ˆ`pick_review_candidates(...)`ï¼‰

- å¤æ ¸å¼‚æ­¥åŒ–ï¼ˆä¸é˜»å¡ grade å®Œæˆï¼‰
  - ç›®æ ‡ä½“éªŒï¼šgrade å…ˆ `done`ï¼›å¤æ ¸é¢˜å¡å…ˆæ˜¾ç¤º `review_pending`ï¼›å¤æ ¸å®Œæˆåå¡ç‰‡å‡çº§ä¸º `review_ready/review_failed`
  - å…³é”®çº¦å®šï¼ˆå¿…é¡»å¯¹é½å‰ç«¯ï¼‰ï¼š**å³ä½¿ `job.status=done`ï¼Œ`job.question_cards[]` ä»å¯èƒ½åœ¨çŸ­æ—¶é—´å†…ç»§ç»­è¢«å¤æ ¸ worker æ›´æ–°**
    - å‰ç«¯è½®è¯¢ç­–ç•¥ï¼šä¸èƒ½åœ¨ `done` ç«‹å³åœæ­¢ pollingï¼›åº”åœ¨â€œæ—  `review_pending` å¡ç‰‡â€æˆ–â€œè¾¾åˆ° timeoutâ€ååœæ­¢
  - åç«¯å®ç°ï¼š`homework_agent/services/review_cards_queue.py`ï¼ˆå…¥é˜Ÿ+é˜²é‡é”ï¼‰+ `homework_agent/workers/review_cards_worker.py`ï¼ˆæ¶ˆè´¹é˜Ÿåˆ—å¹¶ patch job å¡ç‰‡ï¼‰

---

### WSâ€‘Dï¼ˆP2ï¼šä¸Šçº¿å‰å¿…é¡»åšï¼Œä½†ä¸é˜»å¡å½“å‰è¿­ä»£ï¼‰ï¼šVKE/K8s éƒ¨ç½²ä¸æŒ‰éœ€æ‰©ç¼©å®¹ï¼ˆç”Ÿäº§åŒ–ï¼‰

> èƒŒæ™¯ï¼šä½ å·²ç¡®è®¤ä¼˜å…ˆä½¿ç”¨ç«å±±ç”Ÿæ€ï¼ˆDoubao/Arkï¼‰ï¼Œå› æ­¤éƒ¨ç½²ä¼˜å…ˆé€‰ **ç«å±± VKEï¼ˆæ‰˜ç®¡ K8sï¼‰**ã€‚  
> ç›®æ ‡ï¼šæŠŠç³»ç»Ÿæ‹†æˆ `api + 4 workers`ï¼Œå¹¶åšåˆ°â€œæŒ‰éœ€ç‹¬ç«‹æ‰©å®¹ + ä¸ä¸¢ä»»åŠ¡ + å¯è§‚æµ‹ + å¯æ§æˆæœ¬/é™æµâ€ï¼Œä¸ºå…¨å›½æ¨å¹¿åšå‡†å¤‡ã€‚  
> æ–¹æ¡ˆé€‰æ‹©ï¼ˆç»“è®ºï¼‰ï¼šé‡‡ç”¨ **æ–¹æ¡ˆä¸€ï¼ˆVKE/K8s + HPA + KEDAï¼‰**ï¼›ä¸é‡‡ç”¨â€œå•å®ä¾‹å†…è‡ªæ‰©å®¹â€çš„å¹»æƒ³ï¼ˆå•æœºåªèƒ½æ‰‹åŠ¨/å›ºå®šè¿›ç¨‹æ•°ï¼Œæ— æ³•æŒ‰é˜Ÿåˆ—è‡ªåŠ¨ä¼¸ç¼©ï¼‰ï¼Œä¹Ÿä¸ä¼˜å…ˆé‡‡ç”¨â€œæ–¹æ¡ˆäºŒï¼ˆServerless App Engineï¼‰â€æ¥æ‰¿è½½å¤æ‚ worker ç¼–æ’ã€‚
>
> âœ… è¿è¥ä¾§å‚æ•°å†³ç­–ï¼ˆå·²ç¡®è®¤ï¼‰ï¼š
> - **æ‰¿è½½æ–¹å¼**ï¼šé€‰æ‹© **æ–¹æ¡ˆ Bï¼šECS å¸¸é©» + VCI æ‰¿æ¥ burst**ï¼ˆå¸¸é©»ç¨³æ€ + å³°å€¼æŒ‰éœ€å¼¹æ€§ï¼‰ã€‚
> - **grade_worker å• Pod å¹¶å‘**ï¼š`1`ï¼ˆä¼˜å…ˆç¨³æ€/ä½å¤±è´¥ç‡ï¼Œå†ç”¨â€œæ‰© Pod æ•°â€æ‰¿æ¥å³°å€¼ï¼‰ã€‚

#### Dâ€‘0 æ¶æ„æ‹†åˆ†ï¼ˆéƒ¨ç½²è§†è§’ï¼‰

- 5 ä¸ª Deploymentï¼ˆæˆ–åŒç­‰å·¥ä½œè´Ÿè½½ï¼‰ï¼š
  - `api`ï¼šFastAPI/uvicornï¼ˆæ— çŠ¶æ€ï¼Œæ¨ªå‘æ‰©å®¹ï¼‰
  - `grade_worker`ï¼šæ¶ˆè´¹ `grade:queue`ï¼ˆæœ€åƒèµ„æº/æœ€éœ€è¦å¼¹æ€§æ‰©å®¹ï¼‰
  - `review_cards_worker`ï¼šæ¶ˆè´¹ `review_cards:queue`ï¼ˆå°æµé‡ï¼Œå°‘é‡å¸¸é©»å³å¯ï¼‰
  - `facts_worker`ï¼šæ¶ˆè´¹ `facts:queue`ï¼ˆä¸­ç­‰æµé‡ï¼Œå°‘é‡å¸¸é©»å³å¯ï¼‰
  - `report_worker`ï¼šæŸ¥è¯¢/é”å®š `report_jobs`ï¼ˆå°æµé‡ï¼Œå°‘é‡å¸¸é©»å³å¯ï¼‰
- Redis/DB/å¯¹è±¡å­˜å‚¨é‡‡ç”¨æ‰˜ç®¡æœåŠ¡ï¼ˆé›†ç¾¤å¤–éƒ¨ä¾èµ–ï¼‰ï¼ŒPod åªåšè®¡ç®—ä¸ç¼–æ’ã€‚

#### Dâ€‘1 å¥åº·æ£€æŸ¥ä¸å¯æ¢å¤æ€§ï¼ˆä¸ä¸¢ä»»åŠ¡çš„åº•çº¿ï¼‰

- API healthzï¼ˆLiveness/Readinessï¼‰ï¼š
  - `/healthz`ï¼ˆlivenessï¼‰ï¼šè¿›ç¨‹æ´»ç€å³å¯
  - `/readyz`ï¼ˆreadinessï¼‰ï¼šå…³é”®ä¾èµ–å¯ç”¨ï¼ˆè‡³å°‘ Redis å¯ç”¨ï¼›å¯é€‰ï¼šSupabase è¿æ¥å¯ç”¨ï¼‰
- Worker readinessï¼ˆå»ºè®®æä¾›æœ€å°â€œè‡ªæ£€â€èƒ½åŠ›ï¼‰ï¼š
  - æ£€æŸ¥å¿…éœ€ envï¼ˆ`REDIS_URL`ã€`ARK_API_KEY`ã€`SUPABASE_*` ç­‰ï¼‰
  - Redis pingï¼ˆå¿…é¡»ï¼‰
  - å¯é€‰ï¼šSupabase PostgREST æ¢æ´»ï¼ˆé¿å…å¯åŠ¨åç«‹å³å› æƒé™/ç½‘ç»œå¤±è´¥è€Œåå¤ crashï¼‰
- Worker ä¼˜é›…é€€å‡ºï¼š
  - æ”¶åˆ° SIGTERMï¼šåœæ­¢æ‹‰æ–°ä»»åŠ¡ï¼Œå¤„ç†å®Œå½“å‰ä»»åŠ¡åé€€å‡ºï¼ˆé¿å…æ»šåŠ¨å‡çº§ä¸¢ä»»åŠ¡/é‡å¤æ¶ˆè´¹ï¼‰

#### Dâ€‘2 æ‰©ç¼©å®¹ç­–ç•¥ï¼ˆå…ˆå®šæ–¹æ¡ˆï¼Œåç»­è½åœ°ä¸º IaC/YAMLï¼‰

> åŸåˆ™ï¼šåªå¯¹â€œæœ€å½±å“æ’é˜Ÿâ€çš„ `grade_worker` åšå¼ºå¼¹æ€§ï¼›å…¶ä»– worker å°å‰¯æœ¬å¸¸é©»å³å¯ã€‚  
> æ‰©å®¹ç›®æ ‡ï¼šä¼˜å…ˆé™ä½ `queue_wait_ms`ï¼Œæ»¡è¶³â€œå…ˆå¯ç”¨ï¼ˆç¬¬ä¸€é¡µ 2â€“3 åˆ†é’Ÿå†…å¯é—®ï¼‰â€ã€‚

- `api`ï¼šK8s HPAï¼ˆCPU/å†…å­˜/å¹¶å‘æŒ‡æ ‡ï¼‰
  - å»ºè®®ï¼š`minReplicas=2`ï¼Œ`maxReplicas=20`ï¼ŒCPU target 60%
- `grade_worker`ï¼šKEDAï¼ˆé˜Ÿåˆ—æ·±åº¦é©±åŠ¨ï¼‰
  - è§¦å‘æºï¼šRedis List `grade:queue`ï¼ˆæ³¨æ„åŒ…å« `CACHE_PREFIX` æ—¶éœ€ç”¨å®é™… keyï¼‰
  - å»ºè®®ï¼š
    - `minReplicaCount=0..2`ï¼ˆè‹¥é‡‡ç”¨â€œECS å¸¸é©»â€ï¼Œå¯è®¾ä¸º 1â€“2 ä»¥é™ä½å†·å¯åŠ¨ï¼›è‹¥å®Œå…¨ä¾èµ– VCI æ‰¿æ¥å³°å€¼å¯ä¸º 0ï¼‰
    - `maxReplicaCount=50`ï¼ˆå…ˆè®¾ä¿å®ˆä¸Šé™ï¼Œé˜²æ­¢ä¸€é”®æ‰“çˆ†ä¸Šæ¸¸ï¼‰
    - `listLength=10`ï¼ˆç¤ºä¾‹ï¼šé˜Ÿåˆ—æ¯ç§¯å‹ 10 ä¸ª jobï¼Œæ‰© 1 ä¸ª Podï¼›åç»­ç”¨ Aâ€‘4.2 æ•°æ®æ ¡å‡†ï¼‰
    - `cooldownPeriod=300`ï¼ˆé¿å…æŠ–åŠ¨ï¼‰
- `review_cards_worker / facts_worker / report_worker`ï¼š
  - å»ºè®®ï¼šå¸¸é©» `replicas=1..2`ï¼›å¿…è¦æ—¶ä¹Ÿå¯ç”¨ KEDAï¼Œä½†ä¸Šé™åº”å¾ˆå°ï¼ˆä¾‹å¦‚ max=2..5ï¼‰

#### Dâ€‘3 ä¸Šæ¸¸é™æµ/æˆæœ¬æŠ¤æ ï¼ˆâ€œèƒ½æ‰©â€ä¸ç­‰äºâ€œè¯¥æ‰©â€ï¼‰

> ä½ å·²æŸ¥åˆ° Ark æ¨¡å‹é…é¢ï¼šRPM=30000ã€TPM=5000000ã€‚æ¨¡å‹ä¾§é€šå¸¸ä¸æ˜¯é¦–ä¸ªç“¶é¢ˆï¼Œä½†ä»å¿…é¡»åšæŠ¤æ ï¼Œé˜²æ­¢æ‰©å®¹æŠŠå¤±è´¥ç‡æ¨é«˜ã€‚

- `grade_worker` å¹¶å‘æŠ¤æ ï¼ˆä¸¤å±‚ï¼‰ï¼š
  1) **ç¼–æ’å±‚**ï¼šKEDA çš„ `maxReplicaCount`ï¼ˆç¬¬ä¸€å±‚ç¡¬ä¸Šé™ï¼‰
  2) **åº”ç”¨å±‚**ï¼šé¢„ç•™å¼€å…³/å‚æ•°ï¼ˆæœªæ¥è½åœ°ï¼‰ï¼š
     - `GRADE_WORKER_MAX_INFLIGHT_PER_POD`ï¼ˆæ¯ Pod å¹¶å‘ï¼Œé»˜è®¤ 1ï¼‰
     - `ARK_MAX_CONCURRENT_REQUESTS` / `ARK_RPM_SOFT_LIMIT` / `ARK_TPM_SOFT_LIMIT`ï¼ˆè½¯é™æµï¼Œè¶…è¿‡åˆ™é™çº§/æ’é˜Ÿ/needs_reviewï¼‰
- å¯¹è±¡å­˜å‚¨ï¼ˆæœªæ¥è¿ç§»åˆ° Ark/TOSï¼‰æŠ¤æ ï¼š
  - å‚è€ƒï¼ˆTOS çº¦æŸé™åˆ¶ï¼‰ï¼š`https://www.volcengine.com/docs/6349/74823`
  - å…³é”®ï¼šç›‘æ§ 429/æµæ§ headerï¼ˆå¦‚ `x-tos-qos-delay-time`ï¼‰å¹¶åšé‡è¯•/é€€é¿

#### Dâ€‘3.1 æ‰©å®¹â€œå¼€å…³/å‚æ•°â€ï¼ˆä¸Šçº¿å‰å¿…é¡»å†»ç»“å£å¾„ï¼‰

> ç›®çš„ï¼šæ‰©å®¹ä¸æ˜¯â€œè¶Šå¤šè¶Šå¥½â€ï¼Œè€Œæ˜¯â€œå¯æ§åœ°æŠŠæ’é˜Ÿå‹ä½â€ã€‚è¿™äº›å‚æ•°å¿…é¡»æå‰å®šé»˜è®¤å€¼ä¸è°ƒæ•´ç­–ç•¥ï¼Œé¿å…çº¿ä¸Šä¸´æ—¶æ‹è„‘è¢‹ã€‚

- **å®¹é‡è§„åˆ’å£å¾„ï¼ˆå·²ç¡®è®¤ï¼Œä½œä¸ºé¢„è®¾å‡è®¾ï¼‰**
  - å³°å€¼çª—å£ï¼šå­¦æœŸå†… 18:00â€“22:00ï¼ˆå…¶ä½™æ—¶é—´å¹³å³°â‰ˆ0ï¼‰
  - åœ°åŸŸï¼šåä¸œ
  - ä½“éªŒ SLOï¼š`p95(queue_wait_ms) â‰¤ 30s`ï¼ˆâ€œå°½é‡ä¸æ’é˜Ÿâ€ï¼‰
  - å³°å€¼é›†ä¸­åº¦ï¼š18â€“22 æ—¶æ®µå†…â€œå³°å€¼ä¸€åˆ†é’Ÿâ€â‰ˆå‡å€¼çš„ `6Ã—`
  - DAU å‡è®¾ï¼ˆä»˜è´¹+åˆšéœ€ï¼Œä¿å®ˆé«˜é¢„ä¼°ï¼‰ï¼š`100â†’50% / 1000â†’40% / 10000â†’30%`
  - ä¼°ç®—åŸºçº¿ï¼ˆæ¥è‡ª Aâ€‘4ã€3é¡µ/ä»½ï¼‰ï¼š`grade_worker job_elapsed_ms` p50â‰ˆ521sï¼Œp95â‰ˆ681s
  - å¹¶å‘ç²—ç®—ï¼ˆåªé’ˆå¯¹ `grade_worker`ï¼Œpod å¹¶å‘=1ï¼‰ï¼š`pods_needed â‰ˆ Î»_peak(ä»½/åˆ†é’Ÿ) Ã— 11.35(åˆ†é’Ÿ)`ï¼ˆç”¨ p95 æœåŠ¡æ—¶é—´ä¼°ç®—ï¼Œæ»¡è¶³ä¸¥æ ¼ queue_wait SLOï¼‰

- **APIï¼ˆHPAï¼‰**
  - `api.minReplicas / api.maxReplicas`
  - `api.targetCPUUtilizationPercentage`ï¼ˆæˆ–å¹¶å‘æŒ‡æ ‡ï¼‰
- **grade_workerï¼ˆKEDAï¼‰**
  - `grade_worker.minReplicaCount / maxReplicaCount`
  - `pollingInterval / cooldownPeriod`
  - `listLength`ï¼ˆé˜Ÿåˆ—é˜ˆå€¼ï¼šæ¯ç§¯å‹å¤šå°‘ job è§¦å‘æ‰©å®¹ 1 ä¸ª Podï¼‰
  - ï¼ˆå¯é€‰ï¼‰`activationListLength`ï¼ˆä½æ°´ä½ä¸æ‰©å®¹ï¼Œé¿å…æŠ–åŠ¨ï¼‰
- **èŠ‚ç‚¹å±‚ï¼ˆNodePool Autoscaler / VCIï¼‰**
  - `nodepool.min/max`ï¼ˆæˆ– VCI æœ€å¤§å¹¶å‘ä¸Šé™ï¼‰
  - ä¼˜å…ˆæŠŠ `grade_worker` æ”¾åˆ°â€œå¯å¿«é€Ÿæ‰©å®¹â€çš„èŠ‚ç‚¹æ± ï¼ˆæˆ– Serverless èŠ‚ç‚¹æ± ï¼‰
- **åº”ç”¨å±‚å¹¶å‘æŠ¤æ ï¼ˆä¸ Dâ€‘3 å¯¹é½ï¼Œæœªæ¥è½åœ°åˆ°ä»£ç /é…ç½®ï¼‰**
  - `GRADE_WORKER_MAX_INFLIGHT_PER_POD`ï¼ˆé»˜è®¤ 1ï¼‰
  - `ARK_MAX_CONCURRENT_REQUESTS`ï¼ˆé»˜è®¤ 1ï½2ï¼Œç»“åˆ Aâ€‘4.2 æ ¡å‡†ï¼‰
  - â€œåˆ°è¾¾ç‡é«˜ + ä¸Šæ¸¸æ³¢åŠ¨â€æ—¶çš„é™çº§å¼€å…³ï¼šå¤æ ¸å¡æ¯”ä¾‹ä¸‹è°ƒ / `needs_review` å…œåº• / è¶…æ—¶ä¸è§†ä¸ºå¤±è´¥

#### Dâ€‘4 è¿è¥è§†è§’çš„â€œæœ€ä½å¯ä¸Šçº¿â€éªŒæ”¶

- éƒ¨ç½²éªŒæ”¶ï¼š
  - `api` è‡³å°‘ 2 å‰¯æœ¬ï¼Œæ»šåŠ¨å‡çº§ä¸ä¸­æ–­ï¼ˆæˆ–ä¸­æ–­ â‰¤ 30s å¯æ¥å—ï¼‰
  - `grade_worker` å¯ä» 0 è‡ªåŠ¨æ‰©åˆ° Nï¼Œå¹¶åœ¨é˜Ÿåˆ—æ¸…ç©ºåç¼©å›
  - ä»»ä¸€ worker å´©æºƒå¯è‡ªåŠ¨æ‹‰èµ·ï¼Œä¸ä¸¢ä»»åŠ¡ï¼ˆå…è®¸å¹‚ç­‰é‡å¤æ¶ˆè´¹ï¼Œä½†æœ€ç»ˆç»“æœä¸€è‡´ï¼‰
- å¯è§‚æµ‹æ€§éªŒæ”¶ï¼š
  - èƒ½æŒ‰ `job_id/request_id/session_id` ä¸²è”ä¸€æ¬¡æ‰¹æ”¹ï¼ˆæ’é˜Ÿ/æ‰§è¡Œ/å¤æ ¸/å†™åº“ï¼‰
  - èƒ½åŒºåˆ†ï¼šæ¨¡å‹ 429 vs å­˜å‚¨ 429 vs æœ¬åœ°è¶…æ—¶ vs ç½‘ç»œæ³¢åŠ¨

#### Dâ€‘5 ä»£ç æ˜¯å¦éœ€è¦ä¿®æ”¹ï¼Ÿï¼ˆç»“è®ºï¼šK8s/KEDA ä¸å¼ºä¾èµ–ï¼Œä½†ç”Ÿäº§åŒ–éœ€è¦â€œæœ€å°å¿…éœ€â€æ”¹åŠ¨ï¼‰

> ç»“è®ºå£å¾„ï¼ˆç»™å›¢é˜Ÿç»Ÿä¸€ï¼‰ï¼š**é‡‡ç”¨æ–¹æ¡ˆä¸€ä¸éœ€è¦ä¸ºäº†â€œèƒ½è·‘â€å»æ”¹ä¸šåŠ¡é€»è¾‘**ï¼›ä½†ä¸ºäº†â€œå¯è¿ç»´/å¯æ‰©å®¹/å¯æ»šåŠ¨å‡çº§â€ï¼Œéœ€è¦è¡¥é½å°‘é‡ç”Ÿäº§åŒ–æ¥å£ä¸ä¿¡å·å¤„ç†ã€‚

- ä¸éœ€è¦æ”¹ä»£ç ä¹Ÿèƒ½è·‘çš„éƒ¨åˆ†ï¼š
  - K8s Deployment/HPA/KEDA æœ¬èº«ä¸è¦æ±‚æ”¹ `/uploads`/`/grade`/`/jobs` çš„ä¸šåŠ¡é€»è¾‘
  - worker æ‹†åˆ†ä¸º 4 ä¸ªéƒ¨ç½²ä¹Ÿä¸è¦æ±‚æ”¹ä»»åŠ¡æ¨¡å‹ï¼ˆåªè¦ç¯å¢ƒå˜é‡/å…¥å£æ­£ç¡®ï¼‰
- å»ºè®®è¡¥é½çš„â€œæœ€å°å¿…éœ€â€ï¼ˆä¸Šçº¿å‰è¦åšï¼Œé¿å…è¿ç»´è¸©å‘ï¼‰ï¼š
  - APIï¼š
    - `/healthz`ï¼ˆlivenessï¼‰ä¸ `/readyz`ï¼ˆreadinessï¼Œè‡³å°‘ Redis å¯ç”¨ï¼‰
  - Workersï¼š
    - SIGTERM ä¼˜é›…é€€å‡ºï¼ˆåœæ­¢æ‹‰æ–°ä»»åŠ¡ï¼Œå¤„ç†å®Œå½“å‰ä»»åŠ¡å†é€€å‡ºï¼‰
    - å¯åŠ¨æ—¶ fail-fastï¼šç¼ºå…³é”® envï¼ˆå¦‚ `REDIS_URL`ã€`ARK_API_KEY`ã€`SUPABASE_SERVICE_ROLE_KEY`ï¼‰ç›´æ¥é€€å‡ºå¹¶å‘Šè­¦
  - è§‚æµ‹ï¼š
    - ç»Ÿä¸€è¾“å‡º `request_id/job_id/session_id`ï¼Œä¾¿äºæ’é˜Ÿ/æ‰§è¡Œ/å¤æ ¸/å†™åº“å…¨é“¾è·¯å®šä½

- å¤æ ¸æ•°æ®æ¥æºä¸è°ƒç”¨çº¦æŸ
  - ä¼˜å…ˆå¤ç”¨ï¼šqindex äº§å‡ºçš„ bbox/sliceï¼›è‹¥æ— åˆ‡ç‰‡åˆ™ä¸´æ—¶é™çº§ä¸ºæ•´é¡µå¤æ ¸ï¼ˆæ›´æ…¢æ›´è´µï¼Œåªç”¨äºå°‘é‡é¢˜ï¼‰
  - è°ƒç”¨ï¼šVFEï¼ˆè§†è§‰äº‹å®æå–ï¼‰åœ¨ failâ€‘closed ä¸‹è¿è¡Œï¼›è¯æ®ä¸è¶³å¿…é¡»ä¿æŒ/æå‡ä¸º `uncertain`ï¼Œä¸å¾—â€œå¼ºè¡Œåˆ¤å¯¹/åˆ¤é”™â€
  - å®¡è®¡ï¼šè®°å½•å¤æ ¸çš„ gate/æ‘˜è¦/å¿…è¦ä¸Šä¸‹æ–‡ï¼ˆå¿…è¦æ—¶å¯¹é½ Ark response_idï¼‰

- `job.question_cards[]` åè®®ï¼ˆä¾›å‰ç«¯éªŒæ”¶ï¼›ä¸ç ´å 5 å­—æ®µæœ€å°é›†ï¼‰
  - ä»ä¿ç•™æœ€å°é›†ï¼š`item_id/question_number/page_index/answer_state/question_content?`
  - æ–°å¢å­—æ®µï¼ˆå¯é€‰å­—æ®µï¼Œé€æ­¥ä¸°å¯Œï¼‰ï¼š
    - `card_state`ï¼š`placeholder | verdict_ready | review_pending | review_ready | review_failed`
    - `review_reasons[]`ï¼ˆmachine-readableï¼Œâ‰¤8ï¼‰
    - `review_summary`ï¼ˆä¸€å¥è¯/è¦ç‚¹åˆ—è¡¨ï¼ŒUI å‹å¥½ï¼‰
    - å¯é€‰å®¡è®¡å­—æ®µï¼š`vfe_gate` / `vfe_scene_type` / `vfe_image_source` / `vfe_image_urls` / `visual_facts`

- éªŒæ”¶æ ‡å‡†ï¼ˆå‰ç«¯å¯ç›´æ¥ç”¨ï¼‰
  - æœ‰ `review_needed` çš„å¡ï¼šåœ¨ â‰¤ 1 æ¬¡è½®è¯¢å†…è¿›å…¥ `review_pending`
  - å¤æ ¸å®Œæˆåï¼šåœ¨ â‰¤ 1 æ¬¡è½®è¯¢å†…å˜ä¸º `review_ready/review_failed`ï¼Œå¹¶æä¾› `review_summary/review_reasons`
  - éå¤æ ¸é¢˜ä¸å—å½±å“ï¼šä»ä¸º `verdict_ready`ï¼›æ•´ä½“è€—æ—¶ä¸è¢«å…¨é‡æ‹–æ…¢

##### Aâ€‘7.1â€‘FE å‰ç«¯éªŒæ”¶ä¿®å¤æ¸…å•ï¼ˆP0ï¼Œå¿…é¡»åšï¼‰

> ç›®çš„ï¼šæ¶ˆé™¤â€œdone æ”¶å°¾ç«æ€ï¼ˆrace conditionï¼‰â€ï¼Œä¿è¯å¤æ ¸å¡åœ¨ UI ä¸Šå¯éªŒæ”¶ã€å¯ç¨³å®šçœ‹åˆ°æœ€ç»ˆæ€ã€‚

**çŠ¶æ€**ï¼šâœ… å·²å®ŒæˆéªŒæ”¶ï¼ˆå‰ç«¯å·²æŒ‰å£å¾„å®ç°ç¨³å¥è½®è¯¢ä¸å¼ºåˆ¶å¼‚æ­¥ï¼›Reports é¡µçš„ Hooks ç«æ€å¯¼è‡´ç™½å±é—®é¢˜å·²ä¿®å¤ï¼‰

- è½®è¯¢åœæ­¢æ¡ä»¶ï¼ˆRobust Pollingï¼‰
  - ä¸èƒ½åªç”¨ `job.status === done/failed` ä½œä¸ºåœæ­¢æ¡ä»¶ã€‚
  - æ¨èï¼šå½“ä¸”ä»…å½“ `(job.status in {done,failed}) AND (question_cards ä¸­ä¸å­˜åœ¨ card_state==='review_pending')` æ‰åœæ­¢ã€‚
  - å®‰å…¨ä¸Šé™ï¼šè®¾ç½® `max_wait_seconds = GRADE_REVIEW_CARDS_TIMEOUT_SECONDS + 10~20s`ï¼Œè¶…æ—¶åˆ™åœæ­¢å¹¶æç¤ºâ€œéƒ¨åˆ†å¤æ ¸è¶…æ—¶/å¤±è´¥â€ã€‚
  - æ³¨æ„ï¼šåç«¯ä¸å­˜åœ¨ `status=reviewing`ï¼›å¤æ ¸è¿›åº¦ä»¥ `question_cards[].card_state` è¡¨è¾¾ã€‚

- `/grade` åŒæ­¥ done åˆ†æ”¯ï¼ˆé¿å…æ—  job_id å´©æºƒï¼‰
  - æ¨èæ–¹æ¡ˆï¼šå‰ç«¯å¯¹ `/grade` å›ºå®šåŠ  header `X-Force-Async: 1`ï¼Œç»Ÿä¸€èµ°å¼‚æ­¥ `job_id` è½®è¯¢æ¸²æŸ“ï¼ˆæœ€çœæ”¹åŠ¨ã€é€»è¾‘æœ€ç»Ÿä¸€ï¼‰ã€‚
  - å¤‡é€‰ï¼šå‰ç«¯æ”¯æŒâ€œåŒæ­¥ done ä¸”æ—  job_idâ€çš„ç»“æœç›´å‡ºæ¸²æŸ“ï¼ˆä¸èµ° ResultScreen è½®è¯¢ï¼‰ã€‚

- å¤šå›¾ä¸Šä¼ çœŸæ­£ç”Ÿæ•ˆï¼ˆUI/é€»è¾‘ä¸€è‡´ï¼‰
  - `input[multiple]` å·²å¼€ï¼Œä½†éœ€å°† `onUpload` ä» `(file: File)` å‡çº§ä¸º `(files: File[])`ï¼Œå¹¶åœ¨ `FormData` ä¸­å¾ªç¯ `append('file', f)`ã€‚
  - åç«¯ `/uploads` æ¥æ”¶ `file: List[UploadFile]`ï¼ˆåŒåå­—æ®µé‡å¤å³å¯ï¼‰ï¼Œä¸€æ¬¡ä¸Šä¼ =ä¸€æ¬¡ submissionã€‚

- Dev ç”¨æˆ·æ³¨å…¥ï¼ˆä»…å¼€å‘æ€ï¼‰
  - å¦‚éœ€ä½¿ç”¨ `X-User-Id` å…œåº•ï¼ˆæ—  Authï¼‰ï¼Œåº”æ”¹ä¸ºâ€œå¯é…ç½®ä¸”ä»… dev å¯ç”¨â€ï¼ˆä¾‹å¦‚ `VITE_DEV_USER_ID`ï¼‰ï¼Œé¿å…ç¡¬ç¼–ç åœ¨å‰ç«¯ä»£ç ä¸­ã€‚

##### Aâ€‘7.2 Layer 1/2 å ä½/åˆ¤å®šå¡ï¼ˆå·²å…·å¤‡ï¼›å‰ç«¯å¯æš‚ç¼“ï¼‰

- `/jobs/{job_id}` åœ¨ `status=running` æ—¶è¿”å› `question_cards`ï¼ˆè½»é‡åˆ—è¡¨ï¼Œæ”¯æŒå±€éƒ¨æ›´æ–°ï¼Œä¸é—ªå±ï¼‰ï¼š
  - `item_id`ï¼ˆstringï¼Œç¨³å®š keyï¼‰
  - `question_number`ï¼ˆstringï¼‰
  - `page_index`ï¼ˆintï¼Œ0-basedï¼‰
  - `answer_state`ï¼ˆ`blank|has_answer|unknown`ï¼‰
  - `question_content`ï¼ˆå¯é€‰ä½†å¼ºçƒˆå»ºè®®ï¼šé¢˜å¹²å‰ 10â€“20 å­—ï¼‰
- ç©ºé¢˜å£å¾„ï¼šç”¨ `answer_state=blank` è¡¨è¾¾å®¢è§‚äº‹å®ï¼›ä¸å†ä½¿ç”¨â€œæ— æ³•ç¡®è®¤åŸå› â€è¯¯å¯¼ç”¨æˆ·ï¼ˆä¸åšâ€œä¸ä¼š/é—å¿˜â€ç­‰åŠ¨æœºå½’å› ï¼‰ã€‚
- æ—¶é—´å±•ç¤ºå£å¾„ï¼šå‰ç«¯å±•ç¤ºç”¨åç«¯ `elapsed_ms/page_elapsed_ms`ï¼ˆé¿å…åå° Tab é™é¢‘å¯¼è‡´ wall time è™šé«˜ï¼‰ã€‚
- åˆ†å·¥ï¼ˆå¯å¹¶è¡Œï¼‰
  - åç«¯ï¼šç”Ÿæˆä¸å¢é‡æ›´æ–° `question_cards`ï¼ˆå ä½â†’åˆ¤å®šâ†’å¤æ ¸ï¼‰ã€ç¨³å®š `item_id`ã€è·¨é¡µé¢˜å·æ¶ˆæ­§ã€è¾“å‡º elapsed æŒ‡æ ‡
  - å‰ç«¯ï¼šä»¥ `item_id` ä¸º key å±€éƒ¨æ›´æ–°å¡ç‰‡ï¼›å ä½/ç¿»è½¬åŠ¨æ•ˆï¼›ç©ºé¢˜ç°è‰²è™šçº¿å¡ï¼›éƒ¨åˆ†å®Œæˆå³å¯è¿›å…¥è¾…å¯¼

- å½“å‰å®ç°ï¼ˆå·²è½åœ° 2026â€‘01â€‘02ï¼‰
  - `homework_agent/workers/grade_worker.py`ï¼šåœ¨ `status=running` æœŸé—´å†™å…¥ `question_cards`ï¼ˆå ä½â†’åˆ¤å®šï¼‰ï¼Œå¹¶åœ¨ `page_summaries` å¢åŠ  `blank_count`
  - `homework_agent/services/grade_queue.py`ï¼šåˆå§‹åŒ– job payload æ—¶è¡¥é½ `question_cards`
  - `homework_agent/services/autonomous_tools.py`ï¼šæ–°å¢ `ocr_question_cards`ï¼ˆç»“æ„åŒ– OCRï¼Œç”¨äºå ä½å¡ï¼›å¸¦ç¼“å­˜ï¼‰
  - `homework_agent/core/question_cards.py`ï¼šç¨³å®š `item_id`/`answer_state` æ¨æ–­ä¸ merge/sort å·¥å…·
  - `homework_agent/demo_ui.py`ï¼šç›‘æ§é¢æ¿å±•ç¤º `question_cards` æ€»é‡ä¸æŒ‰é¡µç»Ÿè®¡ï¼ˆplaceholder/verdict_ready/blankï¼‰
  - `homework_agent/workers/review_cards_worker.py` + `homework_agent/services/review_cards_queue.py`ï¼š
    - å¤æ ¸å¡å¼‚æ­¥ workerï¼ˆ`review_pending â†’ review_ready/review_failed`ï¼‰ï¼Œä¸é˜»å¡ grade å®Œæˆ
    - è§¦å‘è§„åˆ™ï¼š`homework_agent/core/review_cards_policy.py`ï¼ˆé»˜è®¤ä»…å¤æ ¸è§†è§‰é£é™©ä¸”éœ€è¦å¤æ ¸çš„å°‘é‡é¢˜ï¼‰

##### Aâ€‘8 å†å²é”™é¢˜å¤ä¹ ï¼ˆChat Rehydrateï¼šä¸ä¾èµ– 24h TTLï¼ŒP0ï¼‰

> èƒŒæ™¯ï¼šå½“å‰ 24h TTL æ¸…ç†çš„æ˜¯ **session/qbank/job/qindex ç­‰çŸ­æœŸç¼“å­˜**ï¼ˆRedis è‡ªåŠ¨è¿‡æœŸï¼‰ï¼Œä¸æ˜¯ `submissions` çœŸæºå¿«ç…§ã€‚  
> ç»“æœï¼šé”™é¢˜æœ¬èƒ½çœ‹å†å²ï¼ˆæ¥è‡ª `submissions.grade_result.wrong_items`ï¼‰ï¼Œä½†**ä¸¤å¤©åç‚¹â€œé—®è€å¸ˆâ€å¯èƒ½å› ä¸º session/qbank è¿‡æœŸè€Œæ— æ³•è¾…å¯¼**ï¼Œè¿™ä¸ç¬¦åˆçœŸå®ç”¨æˆ·ä½“éªŒã€‚

- ç›®æ ‡ä½“éªŒï¼ˆç”¨æˆ·å¯æ„ŸçŸ¥ï¼‰
  - ç”¨æˆ·åœ¨ä»»æ„å†å² submissionï¼ˆâ‰¥48hï¼‰é‡Œç‚¹æŸé¢˜â€œé—®è€å¸ˆâ€ï¼Œ**æ— éœ€é‡æ–°ä¸Šä¼ **ï¼Œä¹Ÿèƒ½è¿›å…¥è¾…å¯¼ã€‚
  - ç³»ç»Ÿæ˜ç¡®è¯´æ˜è¯æ®æ¥æºï¼šä»…åŸºäºè¯¥ submission çš„å¿«ç…§/è¯æ®å›ç­”ï¼›è¯æ®ä¸è¶³å¿…é¡» `uncertain/needs_review`ã€‚
- æŠ€æœ¯æ–¹æ¡ˆï¼ˆåç«¯ä¸ºä¸»ï¼Œå‰ç«¯é…åˆå°‘é‡å‚æ•°ï¼‰
  - æ‰©å±• `POST /api/v1/chat` æ”¯æŒâ€œå¤ä¹ æ¨¡å¼â€å‚æ•°ï¼ˆä»»é€‰å…¶ä¸€ï¼ŒäºŒé€‰ä¸€è½åœ°å³å¯ï¼‰ï¼š
    - æ–¹æ¡ˆ Aï¼ˆæ¨èï¼‰ï¼šåœ¨è¯·æ±‚ä½“æ–°å¢ `submission_id`ï¼ˆ= upload_idï¼‰ä¸ `context_item_ids`ï¼ˆè‡³å°‘ 1 ä¸ªé¢˜ idï¼‰ã€‚
    - æ–¹æ¡ˆ Bï¼šæ–°å¢ `POST /api/v1/chat/review`ï¼ˆè¯­ä¹‰æ›´æ¸…æ™°ï¼Œé¿å…å½±å“ç°æœ‰ chatï¼‰ã€‚
  - Rehydrate é€»è¾‘ï¼šå½“ `session_id` ç¼ºå¤±/è¿‡æœŸï¼Œæˆ–æä¾›äº† `submission_id`ï¼š
    - ä» `submissions` è¯»å– `grade_result/questions/wrong_items/judgment_basis`ï¼ˆå¿…è¦æ—¶ `vision_raw_text`ï¼‰ï¼›
    - ç”Ÿæˆä¸€ä¸ª**æ–°çš„** `session_id` ä¸æœ€å° qbankï¼ˆåªå« context é¢˜ + å¿…è¦çš„è¯æ®å­—æ®µï¼‰å†™å…¥ Redisï¼ˆä» 24h TTLï¼‰ï¼›
    - SSE è¿”å›æ—¶åœ¨é¦–åŒ…äº‹ä»¶ä¸­æºå¸¦ `session_id`ï¼ˆå‰ç«¯ä¿å­˜åç»­ç»§ç»­å¯¹è¯ï¼‰ã€‚
- åˆ†å·¥ï¼ˆç”¨äºè”è°ƒéªŒæ”¶ï¼‰
  - å‰ç«¯ï¼šä»â€œé”™é¢˜è¯¦æƒ…â€å‘èµ· chat æ—¶å¸¦ `submission_id + item_id`ï¼ˆä½œä¸º `context_item_ids=[item_id]`ï¼‰ï¼›æ‹¿åˆ°é¦–åŒ… `session_id` åç»§ç»­åŒä¸€ä¼šè¯ã€‚
  - åç«¯ï¼šä¿è¯â€œå†å²é”™é¢˜å¯èŠâ€ä¸ä¾èµ–æ—§ sessionï¼›å¹¶åœ¨å›å¤ä¸­æ ‡æ³¨è¯æ®è¾¹ç•Œï¼ˆä»…è¯¥ submissionï¼‰ã€‚
- éªŒæ”¶æ ‡å‡†ï¼ˆå¯è‡ªåŠ¨åŒ–ï¼‰
  - æ„é€ ä¸€ä¸ª â‰¥48h å‰çš„ submissionï¼ˆæˆ–æ‰‹åŠ¨å°† session TTL è®¾ä¸º 60s å¤ç°è¿‡æœŸï¼‰ï¼Œä»èƒ½æˆåŠŸè¿›å…¥è¾…å¯¼å¹¶å¾—åˆ°ä¸è¯¥é¢˜è¯æ®ä¸€è‡´çš„å›ç­”ï¼›
  - ä¸å‡ºç°â€œè¯·é‡æ–°ä¸Šä¼ /é¢˜åº“å¿«ç…§ä¸å­˜åœ¨â€è¿™ç±»é˜»æ–­æ€§æç¤ºï¼›
  - äº§å‡ºå¯å®¡è®¡å­—æ®µï¼š`submission_id/item_id/session_id` ä¸‰è€…å¯ä¸²è”æ’æŸ¥ã€‚

### WSâ€‘Bï¼šSupabase Schema/RLS/æƒé™ï¼ˆæ”¯æ’‘ Worker ç¨³å®šè¿è¡Œï¼‰

**å†³ç­–åå¥½**ï¼šå› ä¸ºç°é˜¶æ®µæ•°æ®å¯ä¸¢ï¼Œå¯é€‰æ‹©â€œé‡ç½®åˆ°çœŸæº schema + å¢é‡è¡¥é½ç¼ºå¤±è¡¨/å­—æ®µâ€ã€‚ä½†**ç¦æ­¢**å†å¼•å…¥â€œDROP SCHEMA + è¿ç§»æ–‡ä»¶å¼ºå¯¹é½â€è¿™å¥—ä¼šå¯¼è‡´å£å¾„æ¼‚ç§»çš„æ–¹æ¡ˆã€‚

#### Bâ€‘1 Schema çœŸæºä¸å˜æ›´æ–¹å¼

- çœŸæºï¼š`supabase/schema.sql`ï¼ˆç°ç½‘/ç°åº“çœŸå®å£å¾„ï¼‰ã€‚
- å˜æ›´æ–¹å¼ï¼š
  - å¢é‡ SQLï¼ˆæ¨èï¼‰ï¼šä¸º `report_jobs` å¢åŠ é”å­—æ®µï¼›åˆ›å»º `question_attempts/question_steps` æˆ–ç­‰ä»·å®½è¡¨ï¼›è¡¥é½ç´¢å¼•ã€‚
  - æˆ–é‡ç½®ï¼ˆå…è®¸ï¼‰ï¼šè‹¥å†³å®šæ¸…åº“ï¼Œå¯åœ¨ Supabase SQL Editor é‡æ–°æ‰§è¡Œ `supabase/schema.sql` åå†æ‰§è¡Œå¢é‡ SQLã€‚
- éªŒæ”¶ï¼šDB schema ä¸ä»£ç /worker å£å¾„ä¸€è‡´ï¼ˆå­—æ®µ/çŠ¶æ€å€¼/å¯å†™æƒé™ï¼‰ï¼Œä¸å†éœ€è¦â€œé€‚é…å±‚â€ç»•æ¥ç»•å»ã€‚

å‚è€ƒå¢é‡è„šæœ¬ï¼š`supabase/patches/20260101_add_facts_tables_and_report_job_locks.sql`
å¿«é€Ÿæ ¡éªŒå·¥å…·ï¼ˆæ¨èå…ˆç”¨ REST æ ¡éªŒï¼Œå†åš DB ç›´è¿æ ¡éªŒï¼‰ï¼š
- `python3 scripts/verify_supabase_tables_rest.py`ï¼šç”¨ PostgREST éªŒè¯å…³é”®è¡¨/åˆ—å¯è¯»ï¼ˆä¸éœ€è¦ DB å¯†ç ï¼‰
- `python3 scripts/verify_supabase_schema.py`ï¼šç”¨ `SUPABASE_DB_URL` ç›´è¿ Postgres æ ¡éªŒé»˜è®¤å€¼/RLS/ç­–ç•¥ï¼ˆéœ€è¦ DB å¯†ç ï¼‰
- `python3 scripts/apply_supabase_sql.py supabase/patches/20260101_add_facts_tables_and_report_job_locks.sql`ï¼šç›´è¿æ‰§è¡Œ DDLï¼ˆéœ€è¦ DB å¯†ç ï¼›ä»…å¼€å‘åº“ï¼‰

#### Bâ€‘2 RLS/æƒé™è·¯çº¿ï¼ˆPhase 1.5ï¼‰

- æ¨èï¼š**worker ä½¿ç”¨ service role key**ï¼ˆç»•è¿‡ RLSï¼‰ï¼ŒAPI ä»ä½¿ç”¨ anon keyï¼ˆå¼€å‘æœŸï¼‰æˆ– auth keyï¼ˆç”Ÿäº§ï¼‰ã€‚
- é£é™©æ§åˆ¶ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰ï¼š
  - service role key åªå­˜åœ¨äº worker è¿›ç¨‹è¿è¡Œç¯å¢ƒï¼ˆSecret Manager/éƒ¨ç½²ç¯å¢ƒå˜é‡ï¼‰ï¼Œä¸è¿›å…¥ä»“åº“æ–‡ä»¶ã€‚
  - CI å¢åŠ â€œè¯¯æäº¤æ£€æµ‹â€ï¼ˆå·²è½åœ°ï¼Œè§ `scripts/check_no_secrets.py` ä¸ `.github/workflows/ci.yml`ï¼‰ã€‚
  - å»ºè®®ï¼ˆå¯é€‰ï¼‰ï¼šåˆ¶å®šè½®æ¢ç­–ç•¥ï¼ˆä¾‹å¦‚æ¯æœˆ/æ¯æ¬¡ç–‘ä¼¼æ³„éœ²åç«‹åˆ»è½®æ¢ï¼‰ã€‚

**çŠ¶æ€**ï¼šâœ… å·²è½åœ°ï¼ˆworker å·²åœ¨è¿è¡Œç¯å¢ƒå¯ç”¨ `SUPABASE_SERVICE_ROLE_KEY` ä¸” `WORKER_REQUIRE_SERVICE_ROLE=1`ï¼›report/facts worker å¯ç¨³å®šå†™åº“ï¼‰

### WSâ€‘Cï¼šReports/Facts Worker ç«¯åˆ°ç«¯é—­ç¯

#### Câ€‘1 report_jobs çŠ¶æ€ä¸é”

- **æ˜ç¡®å†³ç­–ï¼šé€‰æ‹©æ–¹æ¡ˆ Aï¼ˆæ”¹ DBï¼ŒåŠ é”å­—æ®µï¼‰**ã€‚
  - ç†ç”±ï¼š`locked_at/locked_by` æ˜¯ä¸šç•Œæ ‡å‡†å®è·µï¼›ä¸€æ¬¡æ€§åœ¨ DB å±‚è§£å†³å¹¶å‘æŠ¢å ä¸å¯è§‚æµ‹æ€§é—®é¢˜ï¼Œèƒ½è®© worker ä»£ç æ›´ç®€æ´ã€æ›´å¯ç»´æŠ¤ã€‚
  - å¤‡æ³¨ï¼šæ–¹æ¡ˆ Bï¼ˆåªæ”¹ä»£ç ï¼‰ä»…ä½œä¸ºåº”æ€¥å…œåº•ï¼ˆå½“ DB æ— æ³•å˜æ›´/æƒé™å—é™æ—¶ï¼‰ï¼Œå¦åˆ™ä¼šæŠŠâ€œé”/é‡è¯•/å¹‚ç­‰â€çš„å¤æ‚åº¦è½¬ç§»åˆ°ä»£ç ä¾§ã€‚

- DB ä¾§ï¼ˆæ–¹æ¡ˆ Aï¼Œæ¨èï¼‰ï¼š
  - `report_jobs` å¢åŠ ï¼š`locked_at/locked_by/attempt_count/last_error`ã€‚
  - å…è®¸ worker ç”¨åŸå­æ¡ä»¶æ›´æ–°ï¼ˆ`status in ('queued','pending')` ä¸” `locked_at is null or expired`ï¼‰ã€‚
- ä»£ç ä¾§ï¼š
  - `report_worker` æ”¯æŒæ‹‰å– `queued|pending`ï¼Œå¹¶åœ¨é”æˆåŠŸåæ”¹ä¸º `running`ã€‚
- éªŒæ”¶ï¼šå¤šå®ä¾‹ worker ä¸‹åŒä¸€ job åªä¼šè¢«ä¸€ä¸ª worker å¤„ç†ï¼›å¤±è´¥å¯é‡è¯•ä¸”æœ‰ attempt è®°å½•ã€‚

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆè¿è¡Œæ€éªŒæ”¶ï¼ˆå·²åœ¨æœ¬ Supabase é¡¹ç›®è§‚å¯Ÿåˆ° `queuedâ†’runningâ†’done`ï¼Œå¹¶è½åº“ `locked_* / report_id`ï¼‰

#### Câ€‘2 facts_worker ä¸å°æ‰¹é‡å›å¡«

- äº¤ä»˜ç‰©ï¼š
  - æ”¯æŒâ€œæœ€è¿‘ N æ¡ submissions å›å¡«â€ä¸ºäº‹å®è¡¨ï¼ˆè¿›åº¦æ—¥å¿—/é€Ÿç‡ç»Ÿè®¡/å¯ä¸­æ–­ç»­è·‘ï¼‰ã€‚
  - å›å¡«åè·‘ä¸€æ¬¡â€œç»Ÿè®¡å¯¹æ¯”â€ï¼ˆä¸ submissions.grade_result.questions çš„åˆ†æ¯/åˆ†å­å£å¾„ä¸€è‡´ï¼‰ã€‚
- éªŒæ”¶ï¼š
  - `question_attempts/question_steps` çš„è¡Œæ•°éšå›å¡«å¢é•¿ï¼Œä¸” `mistake_exclusions` èƒ½æ­£ç¡®è¿‡æ»¤ï¼›
  - ç”ŸæˆæŠ¥å‘Šçš„ Features Layer ç»“æœç¨³å®šå¯å®¡è®¡ã€‚

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆè¿è¡Œæ€éªŒæ”¶ï¼ˆäº‹å®è¡¨å·²æŒç»­å†™å…¥ï¼Œå¯ç”¨ `python3 scripts/verify_supabase_tables_rest.py` ä¸è¡¨è¡Œæ•°ç»Ÿè®¡ç¡®è®¤ï¼‰

#### Câ€‘3 æŠ¥å‘Š API ä¸äº§ç‰©

- APIï¼š
  - `POST /reports` åˆ›å»º jobï¼ˆstatus åˆå§‹ä¸ DB é»˜è®¤ä¸€è‡´ï¼š`queued`ï¼‰ã€‚
  - `GET /reports/jobs/{job_id}` æŸ¥è¯¢çŠ¶æ€ï¼›`GET /reports/{report_id}` æŒ‰ `reports.id` æŸ¥è¯¢ï¼ˆå·²ä¿®ï¼‰ã€‚
- éªŒæ”¶ï¼šåˆ›å»ºâ†’worker æ¶ˆè´¹â†’å†™å…¥ `reports`â†’æŸ¥è¯¢è¿”å›é—­ç¯è·‘é€šã€‚

#### Câ€‘4 Report Eligibilityï¼ˆäº§å“å‘¨æœŸé—¨æ§› + Demo å¿«é€Ÿè§£é”ï¼‰

> èƒŒæ™¯ï¼šå‰ç«¯â€œReport è§£é”â€ä¸èƒ½é€šè¿‡ `/mistakes` æ¨æ–­ï¼ˆå…¨å¯¹ submission ä¼šè¢«æ¼æ‰ï¼‰ã€‚åº”ç”±åç«¯æä¾›æƒå¨ç»Ÿè®¡å£å¾„ï¼Œå‰ç«¯åªå±•ç¤ºè¿›åº¦æ¡/ç¦ç”¨æ€ã€‚

- éœ€æ±‚å£å¾„ï¼ˆä¸äº§å“å¯¹é½ï¼‰
  - Demoï¼šâ‰¥3 æ¬¡ submissionï¼ˆä¸çœ‹å¯¹é”™ï¼‰å³å¯è§£é”â€œå‘¨æœŸæ€§æŠ¥å‘Šâ€å…¥å£ï¼ˆç”¨äºè”è°ƒ/æ¼”ç¤ºï¼‰
  - äº§å“ï¼šåŒç§‘ç›® â‰¥3 å¤©ï¼ˆæˆ–é…ç½®å¤©æ•°ï¼‰ä¸”æ»¡è¶³æœ€å° submissions/attempts æ‰è§£é”ï¼ˆé¿å…â€œæ•°æ®ä¸è¶³ä¹Ÿç”ŸæˆæŠ¥å‘Šâ€ï¼‰
- âœ… å·²å®ç°æ¥å£ï¼ˆå¥‘çº¦å·²å†™å…¥ `homework_agent/API_CONTRACT.md`ï¼‰
  - `GET /api/v1/reports/eligibility?mode=demo|periodic&subject=math&min_distinct_days=3&min_submissions=3`
  - è¿”å›ï¼š`eligible/current_submissions/current_distinct_days/required_* /reason`ï¼ˆå¹¶æä¾› demo å‹å¥½çš„æ ·æœ¬ submission_idsï¼‰
- æ•°æ®æºï¼ˆæƒå¨ï¼‰
  - ä¼˜å…ˆï¼š`submissions`ï¼ˆæŒ‰ `created_at` + `subject` + `user_id` èšåˆï¼‰
  - å…œåº•ï¼š`user_uploads`ï¼ˆä»…ä»£è¡¨ä¸Šä¼ ï¼Œä¸ä»£è¡¨ grade å®Œæˆï¼›éœ€è°¨æ…ï¼‰

#### Câ€‘5 Submissions/History Listï¼ˆStitch UIï¼šRecent Activity / Historyï¼‰

> èƒŒæ™¯ï¼šStitch UI éœ€è¦â€œæœ€è¿‘æ‰¹æ”¹è®°å½•/å†å²ä½œä¸šåˆ—è¡¨â€ã€‚æ­¤å£å¾„å¿…é¡»æ¥è‡ª `submissions` çœŸæºï¼ˆä¸èƒ½ç”¨ `/mistakes` æ¨æ–­ï¼Œå¦åˆ™â€œå…¨å¯¹ä½œä¸šâ€ä¼šæ¶ˆå¤±ï¼‰ã€‚
>
> å‰ç«¯çœŸæºï¼š`docs/frontend_design_spec_v2.md`
>
> åç«¯ç¼ºå£æ‰§è¡Œæ¸…å•ï¼š`implementation_plan_backend_gaps.md`

- äº¤ä»˜ç‰©ï¼ˆAPIï¼‰ï¼š
  - `GET /api/v1/submissions?subject=math&limit=20&before=2026-01-03T00:00:00Z`
- è¿”å›å»ºè®®å­—æ®µï¼ˆæœ€å°å¯ç”¨ï¼‰ï¼š
  - `submission_id/created_at/subject/total_pages/done_pages`
  - `summary`ï¼ˆå¯é€‰ï¼Œä½†å»ºè®®æä¾›ï¼‰ï¼š`total_items/wrong_count/uncertain_count/blank_count/score_text`
  - `session_id`ï¼ˆå¯é€‰ï¼‰ï¼šè‹¥å­˜åœ¨ä¸”ä»æœ‰æ•ˆï¼Œå‰ç«¯å¯ç›´æ¥è¿›å…¥è¾…å¯¼ï¼›å¦åˆ™èµ° Aâ€‘8ï¼ˆRehydrateï¼‰
- æ•°æ®æºï¼š
  - `submissions` è¡¨ï¼ˆæŒ‰ `user_id + subject + created_at desc`ï¼‰
  - `summary` ä¼˜å…ˆä» `grade_result` å¿«ç…§è®¡ç®—ï¼ˆå…è®¸ä¸ºç©ºï¼Œå‰ç«¯é™çº§å±•ç¤ºâ€œå·²æ‰¹æ”¹/æŸ¥çœ‹è¯¦æƒ…â€ï¼‰
- éªŒæ”¶ï¼š
  - Home Recent Activity èƒ½å±•ç¤ºæœ€è¿‘ N æ¬¡ä½œä¸šï¼ˆåŒ…å«å…¨å¯¹ä½œä¸šï¼‰
  - History åˆ—è¡¨ç‚¹å‡»è¿›å…¥â€œä½œä¸šè¯¦æƒ…â€ï¼ˆæ–¹æ¡ˆ Bï¼šå¿«ç…§è¯¦æƒ…ï¼‰ï¼š`GET /api/v1/submissions/{submission_id}`ï¼Œæ— éœ€é‡å»º job

#### Câ€‘6 Submissions/History Detailï¼ˆæ–¹æ¡ˆ Bï¼šå¿«ç…§è¯¦æƒ…ï¼‰

- äº¤ä»˜ç‰©ï¼ˆAPIï¼‰ï¼š
  - `GET /api/v1/submissions/{submission_id}`
- è¿”å›å­—æ®µï¼ˆç”¨äºå‰ç«¯ç›´æ¥æ¸²æŸ“ï¼‰ï¼š
  - `question_cards/page_summaries/page_image_urls/session_id`
- ä»·å€¼ï¼š
  - è®¿é—®å†å²ä½œä¸šâ€œç§’å¼€â€ï¼ˆä¸èµ° LLM/é˜Ÿåˆ—ï¼‰
  - ä½œä¸ºâ€œé”™é¢˜æœ¬/å†å²è®°å½•â€çš„æƒå¨è¯¦æƒ…é¡µï¼ˆå¹¶ä¸ Aâ€‘8 Rehydrate ç»„åˆï¼Œä¿è¯æ—§ä½œä¸šå¯èŠï¼‰

## 3) éªŒè¯ä¸æµ‹è¯•æ–¹æ¡ˆï¼ˆå¿…é¡»å†™è¿›äº¤ä»˜ï¼‰

### 3.1 ä»£ç çº§ï¼ˆCIï¼‰

- `pytest -q`ï¼šä¿è¯å•å…ƒæµ‹è¯•/å¥‘çº¦æµ‹è¯•å…¨ç»¿ã€‚
- `scripts/check_no_secrets.py`ï¼šé˜»æ­¢ service role key/JWT è¯¯è¿›ä»“åº“ï¼ˆå·²è½åœ°ï¼‰ã€‚

### 3.2 ç«¯åˆ°ç«¯ï¼ˆæœ¬åœ°/è”è°ƒï¼‰

- `/grade`ï¼š
  - åŒä¸€å¼ å›¾é‡å¤è·‘ 3 æ¬¡ï¼Œè®°å½• `timings_ms` ä¸ `response_id`ï¼›
  - åˆ‡æ¢ `GRADE_IMAGE_INPUT_VARIANT` ä¸ `ARK_IMAGE_PROCESS_ENABLED`ï¼Œè¾“å‡ºå¯¹æ¯”è¡¨ã€‚
- `/reports`ï¼š
  - åˆ›å»º job â†’ worker æŠ¢å  â†’ done/failed â†’ æŸ¥è¯¢ reportã€‚

## 4) é£é™©æ¸…å•ï¼ˆRisk Registerï¼‰

- service role key æ³„éœ²ï¼šæœ€é«˜é£é™© â†’ CI æ£€æµ‹ + Secret Manager + è½®æ¢ã€‚
- schema å£å¾„æ¼‚ç§»ï¼šä¼šå¯¼è‡´ worker/æŠ¥å‘Šâ€œçœ‹ä¼¼è·‘äº†ä½†å…¨æ˜¯ç©º/é”™â€ â†’ ä»¥ `supabase/schema.sql` ä¸ºçœŸæº + å¢é‡ SQLã€‚
- RLS è¯¯é…ç½®ï¼šworker æ— æ³• UPDATE â†’ worker ç”¨ service role æˆ–æ˜ç¡®çš„æœ€å° UPDATE policyï¼ˆä»…å¼€å‘æœŸï¼‰ã€‚
- ç›²ç›®è¿½æ±‚é€Ÿåº¦ï¼šå¯¼è‡´â€œäº’æ–¥/å¹»è§‰/è¯¯åˆ¤â€ â†’ å¼ºåˆ¶è¯æ®é“¾ã€uncertainã€å›æŸ¥ response_idã€‚

## 5) ä¸ 90 å¤©è·¯çº¿å›¾/Backlog çš„å¯¹é½ç»“è®º

### 5.1 å¯¹é½ç‚¹ï¼ˆä¸€è‡´ï¼‰

- è·¯çº¿å›¾ Week 1 çš„ â€œSchema å¯¹é½ï¼ˆP0ï¼‰/è¿è¡Œæ‰‹å†Œ/å¯è§‚æµ‹æ€§â€ ä¸æœ¬è®¡åˆ’ WSâ€‘B å®Œå…¨ä¸€è‡´ã€‚
- è·¯çº¿å›¾ Week 2â€“4 çš„ â€œæŠ¥å‘Šé“¾è·¯æ‰“åº•/Worker æ‹“æ‰‘/Redis å¿…é€‰â€ ä¸æœ¬è®¡åˆ’ WSâ€‘C ä¸€è‡´ã€‚
- Backlog çš„ WLâ€‘P1â€‘010ï¼ˆæŠ¥å‘Š jobs + å­¦æƒ…åˆ†æå¸ˆï¼‰ä¸æœ¬è®¡åˆ’ WSâ€‘C æ–¹å‘ä¸€è‡´ã€‚

### 5.2 å·²å›å†™åˆ° Backlog çš„å£å¾„ä¿®æ­£ï¼ˆâœ…ï¼‰

- `report_jobs` çŠ¶æ€ï¼šå·²ç»Ÿä¸€ä¸º `queued` ä¸ºé»˜è®¤å£å¾„ï¼Œworker å…¼å®¹ `queued|pending`ï¼ˆä¸ `supabase/schema.sql` ä¸€è‡´ï¼‰ã€‚
- Design Doc è·¯å¾„ï¼šå·²ç»Ÿä¸€å¼•ç”¨ `docs/archive/design/mistakes_reports_learning_analyst_design.md`ã€‚
- P0 å·¥ç¨‹ä»»åŠ¡ï¼šå·²æ”¶æ•›ä¸º Backlog æ¡ç›®å¹¶æŒç»­ç»´æŠ¤ï¼š
  - `WLâ€‘P0â€‘007ï¼š/grade æ€§èƒ½æ‹†è§£ä¸è¾“å…¥ç­–ç•¥å¯¹æ¯”ï¼ˆurl/proxy/data_url + image_processï¼‰`
  - `WLâ€‘P0â€‘008ï¼šWorker service role key æ²»ç†ï¼ˆCI é˜²æ³„éœ² + è¿è¡Œæ‰‹å†Œï¼‰`
