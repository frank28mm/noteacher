# A‑4 生产等价（worker=2）复测结论摘要（以稳定性/排队为核心）

本摘要用于把 A‑4 的“证据数据”翻译成可执行的容量与体验结论。原始明细见：

- `docs/reports/a4_w2_burst20_p3_empty.md`（空队列起步，burst=20，3页/次）
- `docs/reports/a4_w2_preload4_burst10_p3_backlog.md`（模拟小积压，preload=4 + burst=10，3页/次）
- `docs/reports/a4_worker_sensitivity_w1_w4_summary_20260105.md`（补齐 A‑4.2：worker=1 vs worker=4 并发敏感性）

## 1) 我们真正想验证的是什么

你已经明确：**整份作业 TTD 不必严格 ≤180s**，允许 15–20 分钟（甚至更久），前提是：

- 用户能尽快看到“第一页可用”（可开始看结果/提问）
- 系统稳定（不要卡死/无限排队/大面积失败）
- 队列排队可控（生产通过弹性扩容解决）

因此 A‑4 的核心口径应拆成两类：

- **单个作业的“内部速度”（不含排队）**：worker 开始跑以后，第 1 页多久可用？
- **系统的“队列速度”（排队）**：在峰值并发下，用户需要等多久 job 才开始跑？

## 2) 关键观测（以本次样本为准）

### 2.1 单个作业内部（不含排队）：第 1 页可用≈3 分钟

从 `a4_w2_burst20_p3_empty.json` 的已完成样本中推导：

- `TTV(page1_after_start) ≈ ttv_first_page_ms - queue_wait_ms`
  - p50 ≈ **166s**
  - p95 ≈ **205s**

结论：**只要 job 能启动，第一页在 2–3 分钟内可用**（符合你“180s 内看到东西”的体感目标）。

### 2.2 系统排队（队列）：worker=2 无法承受 burst=20 的峰值

同一轮（worker=2、3页/次、burst=20）里，已完成样本的排队时间（`queue_wait_ms`）非常高：

- p50 ≈ **24 分钟**
- p95 ≈ **49 分钟**

并且由于总量太大，**有部分 job 在 1 小时观测窗口内未完成**（旧脚本超时会记为失败；后续脚本已把“超时”改为可记录的 `timeout`，避免把“还在跑”误判成 failed）。

结论：**当前的快路径并不是主要问题，系统瓶颈是“worker 并发/队列积压”**。

### 2.3 稳定性：Supabase Storage 在并发上传下出现 SSL EOF

在 `preload=4 + burst=10` 的积压测试里出现：

- `/uploads` 500：`[SSL: UNEXPECTED_EOF_WHILE_READING]`

结论：这属于“测试环境的存储侧稳定性”问题。你已明确生产会迁移到国内对象存储（很可能是 Ark），因此：

- **短期**：A‑4 压测需限制上传并发（脚本已支持 `--upload-concurrency`）
- **中期**：迁移存储后再做一次同口径复测（更贴近生产）

## 3) 容量推导（给你一个直觉）

本次样本下，单个 submission（3页）`worker_elapsed_ms` p50 ≈ **521s（≈8.7min）**。

如果峰值到达率按你给的 **20 submissions/min**：

- 理论并发需求 ≈ 到达率 × 服务时间 ≈ 20 × 8.7 ≈ **174 个并发 worker** 才能把“排队”压到很低。

这不是让你立刻上 174 个 worker，而是告诉你：  
**“峰值并发 20/min” 是一个会把系统推到队列为主的指标，必须靠弹性扩缩容和限流/排队策略来解决。**

## 4) 结论（A‑4 当前完成了什么 / 还差什么）

### 已完成（本轮 A‑4 的有效结论）

- 快路径内部可用性：job 启动后，第 1 页 2–3 分钟内可用（满足“先可用、再慢慢全量”的体验目标）。
- 系统容量瓶颈明确：worker=2 在 burst=20 下会导致长时间排队，用户前几十分钟看不到任何结果（不符合产品体验）。
- 环境型不稳定点明确：并发上传触发 Supabase SSL EOF（生产迁移后应消失，但压测口径要先隔离它）。

### 仍需补（你已允许“回头再做”的部分）

- worker 并发敏感性：已完成 **worker=1 vs worker=4**（burst=10、3页/次），用于指导“最低并发/扩容阈值”。证据见：
  - `docs/reports/a4_worker_sensitivity_w1_w4_summary_20260105.md`
- 生产存储复测：切到 Ark/国内对象存储后，再跑一次同口径（更贴近生产）。
