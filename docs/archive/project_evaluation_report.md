# ä½œä¸šæ£€æŸ¥å¤§å¸ˆ - å…¨é¢é¡¹ç›®è¯„ä¼°æŠ¥å‘Š

> **è¯„ä¼°æ—¥æœŸ**: 2025-12-28
> **é¡¹ç›®ç‰ˆæœ¬**: `7c2f4a7b` (dev/å¼€å‘åˆ†æ”¯)
> **è¯„ä¼°èŒƒå›´**: æ•´ä¸ªé¡¹ç›®ä»£ç åº“

---

## ä¸€ã€æ€»ä½“è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | ç­‰çº§ | ç®€è¯„ |
|------|------|------|------|
| **éœ€æ±‚åŒ¹é…åº¦** | 90/100 | A | P0 ä»»åŠ¡åŸºæœ¬å®Œæˆï¼Œæ ¸å¿ƒåŠŸèƒ½å·²å®ç° |
| **ä»£ç è´¨é‡** | 85/100 | B+ | æ¶æ„æ¸…æ™°ï¼Œé”™è¯¯å¤„ç†å¥å…¨ï¼Œéƒ¨åˆ†æ¨¡å—è¿‡å¤§ |
| **æ¶æ„è®¾è®¡** | 88/100 | A- | åˆ†å±‚åˆç†ï¼Œæ¨¡å—åŒ–ç¨‹åº¦é«˜ï¼Œæ‰©å±•æ€§è‰¯å¥½ |
| **æµ‹è¯•è¦†ç›–** | 82/100 | B+ | 205 ä¸ªæµ‹è¯•ï¼Œè¦†ç›–ä¸»è¦åœºæ™¯ï¼ŒE2E å¾…è¡¥é½ |
| **ç”Ÿäº§å°±ç»ªæ€§** | 78/100 | B | å¯è§‚æµ‹æ€§å®Œå¤‡ï¼Œéƒ¨åˆ†ç”Ÿäº§é…ç½®å¾…å›ºåŒ– |
| **CI/CD** | 85/100 | B+ | é—¨ç¦å®Œæ•´ï¼Œå›å½’æ£€æµ‹å¯ç”¨ |
| **æ–‡æ¡£å®Œæ•´æ€§** | 90/100 | A | è§„èŒƒæ–‡æ¡£é½å…¨ï¼Œå¼€å‘æŒ‡å—æ¸…æ™° |
| **ç»¼åˆè¯„åˆ†** | **85/100** | **B+** | **å¯ä¸Šçº¿ï¼Œéœ€å…³æ³¨æ ‡æ³¨é—®é¢˜** |

---

## äºŒã€é¡¹ç›®è§„æ¨¡ç»Ÿè®¡

### 2.1 ä»£ç é‡

| ç±»åˆ« | æ•°é‡ |
|------|------|
| Python æ–‡ä»¶æ€»æ•° | ~5,800+ |
| æºä»£ç è¡Œæ•°ï¼ˆä¸å«æµ‹è¯•ï¼‰ | ~14,300 è¡Œ |
| æµ‹è¯•ä»£ç è¡Œæ•° | ~4,000 è¡Œ |
| æµ‹è¯•ç”¨ä¾‹æ•° | 205 ä¸ª |
| å‡½æ•°/æ–¹æ³•æ•°ï¼ˆAPI+Servicesï¼‰ | ~279 ä¸ª |
| async å‡½æ•°æ•° | ~2,700+ ä¸ª |

### 2.2 æ¨¡å—åˆ†å¸ƒ

| æ¨¡å— | æ–‡ä»¶æ•° | ä¸»è¦èŒè´£ |
|------|--------|---------|
| `api/` | 8 | HTTP æ¥å£å±‚ï¼šgrade/chat/upload/session/review |
| `services/` | 17 | ä¸šåŠ¡é€»è¾‘ï¼šLLM/Vision/OCR/Autonomous Agent |
| `utils/` | 17 | å·¥å…·ï¼šç¼“å­˜/æ—¥å¿—/é…ç½®/å®‰å…¨/æŒ‡æ ‡ |
| `tests/` | 44 | å•å…ƒæµ‹è¯•/é›†æˆæµ‹è¯•/Replay æµ‹è¯• |
| `core/` | 9 | æ ¸å¿ƒï¼šå·¥å…·æ³¨å†Œ/æ¨¡å‹å®šä¹‰ |
| `security/` | 2 | å®‰å…¨ï¼šPII æ£€æµ‹/è„±æ• |
| `workers/` | 1 | åå°ä»»åŠ¡ï¼šQIndex Worker |

### 2.3 ä¾èµ–åˆ†æ

**æ ¸å¿ƒä¾èµ–ï¼ˆ26 ä¸ªåŒ…ï¼‰**ï¼š
- Web æ¡†æ¶ï¼šFastAPIã€Uvicorn
- LLMï¼šOpenAIã€LangChain
- æ•°æ®åº“ï¼šSupabaseã€Redis
- å›¾åƒå¤„ç†ï¼šOpenCVã€Pillowã€PIL-HEIFã€PyMuPDF
- éªŒè¯ï¼šPydantic
- å…¶ä»–ï¼šTenacityï¼ˆé‡è¯•ï¼‰ã€Jinja2ã€SymPy

---

## ä¸‰ã€éœ€æ±‚åŒ¹é…åº¦è¯„ä¼°

### 3.1 å¯¹ç…§ `agent_sop.md` æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | å®ç°ä½ç½® |
|------|------|---------|
| æ•°å­¦æ‰¹æ”¹ | âœ… å®Œæˆ | `llm.py:grade_math()` |
| è‹±è¯­æ‰¹æ”¹ | âœ… å®Œæˆ | `llm.py:grade_english()` |
| è‹æ ¼æ‹‰åº•è¾…å¯¼ | âœ… å®Œæˆ | `llm.py:socratic_tutor()` + ReAct Loop |
| SSE æµå¼è¾“å‡º | âœ… å®Œæˆ | `chat.py` + `_chat_stages.py` |
| å›¾åƒé¢„å¤„ç† | âœ… å®Œæˆ | `preprocessing.py` + `opencv_pipeline.py` |
| é¢˜ç›®ç´¢å¼•å®šä½ | âœ… å®Œæˆ | `qindex_locator_siliconflow.py` |
| ä¼šè¯çŠ¶æ€ç®¡ç† | âœ… å®Œæˆ | `session.py` + `session_state.py` |
| å¹‚ç­‰æ€§æ”¯æŒ | âœ… å®Œæˆ | `grade.py:check_idempotency()` |
| å®¡æ ¸é˜Ÿåˆ— | âœ… å®Œæˆ | `review_queue.py` + `review.py` |

### 3.2 å¯¹ç…§ `development_rules.md`

| è§„åˆ™ | çŠ¶æ€ | è¯æ® |
|------|------|------|
| å¯è§‚æµ‹æ€§ä¼˜å…ˆ | âœ… | 195 å¤„ log_event/trace_span è°ƒç”¨ |
| è¯„ä¼°é©±åŠ¨å¼€å‘ | âœ… | replay æ•°æ®é›† + CI é—¨ç¦ |
| å®‰å…¨å·¦ç§» | âœ… | bandit + pylint + PII è„±æ• |
| ç‰ˆæœ¬å¯è¿½æº¯ | âœ… | prompt YAML ç‰ˆæœ¬åŒ– |
| æµ‹è¯•åˆ†å±‚ | âš ï¸ | Unit/Contract å®Œå¤‡ï¼ŒE2E å¾…è¡¥é½ |
| å˜æ›´å¯å›æ»š | âš ï¸ | ç¼º migrations ç›®å½• |

### 3.3 å¯¹ç…§ `homework_agent/API_CONTRACT.md`

| æ¥å£ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| POST /api/v1/grade | âœ… | æ”¯æŒåŒæ­¥+å¼‚æ­¥æ¨¡å¼ |
| POST /api/v1/chat | âœ… | SSE æµå¼ |
| GET /api/v1/sessions | âœ… | åˆ†é¡µæŸ¥è¯¢ |
| POST /api/v1/upload | âœ… | å›¾ç‰‡ä¸Šä¼  |
| /review/* | âœ… | å®¡æ ¸å·¥ä½œæµ |
| /metrics | âœ… | Prometheus æ ¼å¼ |

---

## å››ã€ä»£ç è´¨é‡è¯„ä¼°

### 4.1 ä¼˜ç‚¹

1. **ç±»å‹æ³¨è§£å®Œå¤‡**
   - Pydantic æ¨¡å‹ç”¨äºè¯·æ±‚/å“åº”éªŒè¯
   - å‡½æ•°ç­¾åæ™®éæœ‰ç±»å‹æ ‡æ³¨

2. **é”™è¯¯å¤„ç†å¥å…¨**
   - çº¦ 6,600+ å¤„ try/except
   - è‡ªå®šä¹‰é”™è¯¯ç ä½“ç³» (`utils/errors.py`)
   - é™çº§ä¸é‡è¯•ç­–ç•¥ (Tenacity)

3. **å¯è§‚æµ‹æ€§å®Œå¤‡**
   - ç»“æ„åŒ–æ—¥å¿— (`log_event`)
   - è¿½è¸ªè£…é¥°å™¨ (`@trace_span`)
   - LLM Token ä½¿ç”¨è®°å½• (`log_llm_usage`)
   - Prometheus æŒ‡æ ‡ (`/metrics`)

4. **å®‰å…¨æ„è¯†å¼º**
   - PII æ£€æµ‹ä¸è„±æ•
   - Prompt Injection æ£€æµ‹
   - URL æ•æ„Ÿå‚æ•°è¿‡æ»¤

### 4.2 å¾…æ”¹è¿›

1. **éƒ¨åˆ†æ¨¡å—è¿‡å¤§**
   - `chat.py` 67KB / `demo_ui.py` 66KB / `llm.py` 56KB
   - å»ºè®®æŒ‰åŠŸèƒ½æ‹†åˆ†

2. **éƒ¨åˆ†ç¡¬ç¼–ç **
   - è¶…æ—¶å€¼ã€é‡è¯•æ¬¡æ•°åˆ†æ•£åœ¨ä»£ç ä¸­
   - å»ºè®®ç»Ÿä¸€åˆ°é…ç½®

3. **å¼‚æ­¥/åŒæ­¥æ··ç”¨**
   - éƒ¨åˆ† LLM è°ƒç”¨æ˜¯åŒæ­¥é˜»å¡çš„
   - `_call_blocking_in_thread` ä½œä¸ºè¿‡æ¸¡æ–¹æ¡ˆ

### 4.3 ä»£ç é£æ ¼

```
âœ… check_observability.py --strict: 0 errors, 0 warnings
âœ… pylint --enable=E0602: é€šè¿‡
âœ… bandit: é€šè¿‡
```

---

## äº”ã€æ¶æ„è®¾è®¡è¯„ä¼°

### 5.1 åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              main.py (FastAPI)          â”‚
â”‚  Middleware: RequestID, CORS, Metrics   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              api/ (è·¯ç”±å±‚)               â”‚
â”‚  grade.py | chat.py | session.py | ...  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           services/ (ä¸šåŠ¡å±‚)             â”‚
â”‚ autonomous_agent.py | llm.py | vision.pyâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           utils/ (å·¥å…·å±‚)                â”‚
â”‚ cache.py | settings.py | observability  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           security/ (å®‰å…¨å±‚)             â”‚
â”‚         safety.py (PII/è„±æ•)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Autonomous Agent æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Planner  â”‚ â”€â”€â–¶ â”‚ Executor â”‚ â”€â”€â–¶ â”‚ Reflector â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²                                 â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¾ªç¯è¿­ä»£ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Aggregator  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 æ‰©å±•æ€§è¯„ä¼°

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| Provider æ‰©å±• | A | æ”¯æŒ Ark/Silicon/OpenAIï¼Œæ˜“äºæ–°å¢ |
| åŠŸèƒ½æ‰©å±• | A | Tool Registry æœºåˆ¶ï¼Œ@tool è£…é¥°å™¨ |
| å­¦ç§‘æ‰©å±• | B+ | Math/English å·²å®ç°ï¼Œéœ€å¤åˆ¶ prompt |
| æ°´å¹³æ‰©å±• | B | ç›®å‰å•å®ä¾‹ï¼ŒWorker åŒ–å¾…å®Œæˆ |

---

## å…­ã€æµ‹è¯•è¦†ç›–è¯„ä¼°

### 6.1 æµ‹è¯•åˆ†å¸ƒ

| ç±»å‹ | æ•°é‡ | è¦†ç›–æ¨¡å— |
|------|------|---------|
| å•å…ƒæµ‹è¯• | ~150 | utils/services/models |
| é›†æˆæµ‹è¯• | ~30 | API è·¯ç”±/Redis |
| Contract æµ‹è¯• | ~15 | ToolResult/SSE/Schema |
| Replay æµ‹è¯• | 5 æ ·æœ¬ | ç¦»çº¿å›å½’ |

### 6.2 æµ‹è¯•é€šè¿‡æƒ…å†µ

```
205 passed, 3 skipped, 23 warnings in 85.31s
```

### 6.3 è¦†ç›–ç›²åŒº

- âŒ E2E å†’çƒŸæµ‹è¯• (`/upload â†’ /grade â†’ /chat`)
- âŒ è¾¹ç•Œæ¡ä»¶æµ‹è¯•ï¼ˆè¶…æ—¶/é™æµ/é¢„ç®—è€—å°½ï¼‰
- âš ï¸ Live Replayï¼ˆéœ€æ‰‹åŠ¨è§¦å‘ï¼Œå·²éªŒè¯é€šè¿‡ï¼‰

---

## ä¸ƒã€ç”Ÿäº§å°±ç»ªæ€§è¯„ä¼°

### 7.1 å®‰å…¨æ€§

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è®¤è¯ | âœ… | Supabase JWT éªŒè¯ |
| æˆæƒ | âš ï¸ | åŸºäº user_idï¼Œæ— è§’è‰²æ¨¡å‹ |
| PII è„±æ• | âœ… | æ‰‹æœº/é‚®ç®±/èº«ä»½è¯/å­¦å· |
| Prompt Injection | âœ… | æ£€æµ‹ + æ ‡è®° needs_review |
| Secret ç®¡ç† | âœ… | .env + settings |
| CORS | âœ… | ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ allowlist |

### 7.2 å¯é æ€§

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| é‡è¯•ç­–ç•¥ | âœ… | Tenacity + backoff |
| è¶…æ—¶æ§åˆ¶ | âœ… | Budget + deadline |
| é™çº§ç­–ç•¥ | âœ… | Ark â†’ Qwen3 fallback |
| å¹‚ç­‰æ€§ | âœ… | åŸºäº X-Idempotency-Key |
| å¹¶å‘é™åˆ¶ | âœ… | Semaphore æ§åˆ¶ |

### 7.3 æ€§èƒ½

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç¼“å­˜ | âœ… | Memory + Redis |
| å¼‚æ­¥ | âš ï¸ | éƒ¨åˆ†é˜»å¡è°ƒç”¨ |
| è¿æ¥æ±  | âœ… | httpx/redis |
| Token æŠ¤æ  | âœ… | RunBudget |

### 7.4 å¯è§‚æµ‹æ€§

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç»“æ„åŒ–æ—¥å¿— | âœ… | log_event |
| è¿½è¸ª | âœ… | @trace_span |
| æŒ‡æ ‡ | âœ… | /metrics (Prometheus) |
| å‘Šè­¦ | âŒ | æœªé…ç½® |

---

## å…«ã€CI/CD è¯„ä¼°

### 8.1 CI æµæ°´çº¿

| é˜¶æ®µ | çŠ¶æ€ | å·¥å…· |
|------|------|------|
| ç¼–è¯‘æ£€æŸ¥ | âœ… | compileall |
| å•å…ƒæµ‹è¯• | âœ… | pytest |
| å¯è§‚æµ‹æ€§æ£€æŸ¥ | âœ… | check_observability.py |
| å®‰å…¨æ‰«æ | âœ… | bandit + pylint |
| Replay è¯„ä¼° | âœ… | test_replay.py + metrics |
| å›å½’æ£€æµ‹ | âœ… | check_baseline.py |
| Redis é›†æˆæµ‹è¯• | âœ… | ç‹¬ç«‹ Job |

### 8.2 å¾…è¡¥å……

- âŒ ä»£ç æ ¼å¼åŒ–æ£€æŸ¥ (black/ruff)
- âŒ ç±»å‹æ£€æŸ¥ (mypy)
- âŒ ä¾èµ–å®‰å…¨æ‰«æ (safety)

---

## ä¹ã€é£é™©ç‚¹ä¸ä¼˜åŒ–å»ºè®®

### 9.1 ğŸ”´ é«˜ä¼˜å…ˆçº§

| é£é™© | å»ºè®® |
|------|------|
| SSE å¿ƒè·³/æ–­çº¿å£å¾„ä¸ä¸€è‡´ | ç»Ÿä¸€æ–‡æ¡£ä¸å®ç°ï¼ˆ30s/90s vs 10sï¼‰ |
| Chat relook èƒ½åŠ›è¾¹ç•Œæ¨¡ç³Š | æ˜ç¡®é»˜è®¤ç­–ç•¥ï¼Œæ ‡æ³¨ä»£ç  |
| Worker åŒ–æœªå®Œæˆ | å®ç° Redis Queue + grade_worker |

### 9.2 ğŸŸ¡ ä¸­ä¼˜å…ˆçº§

| é£é™© | å»ºè®® |
|------|------|
| å¤§æ–‡ä»¶æ‹†åˆ† | chat.py/llm.py æ‹†åˆ†ä¸ºå­æ¨¡å— |
| Golden Set è§„æ¨¡ä¸è¶³ | æ‰©å……è‡³ 20-30 ä¸ªæ ·æœ¬ |
| E2E æµ‹è¯•ç¼ºå¤± | å®ç° /uploadâ†’/gradeâ†’/chat å†’çƒŸ |
| Migration æ¡†æ¶ç¼ºå¤± | æ­å»º migrations/ ç›®å½•ç»“æ„ |

### 9.3 ğŸŸ¢ ä½ä¼˜å…ˆçº§

| é£é™© | å»ºè®® |
|------|------|
| å‘Šè­¦æœªé…ç½® | é›†æˆ Slack/PagerDuty |
| ä»£ç æ ¼å¼åŒ–æœªå¼ºåˆ¶ | CI åŠ  black --check |
| æ–‡æ¡£ä¸ä»£ç åŒæ­¥ | è‡ªåŠ¨åŒ–æ–‡æ¡£ç”Ÿæˆ |

---

## åã€ç»“è®º

### âœ… é¡¹ç›®äº®ç‚¹

1. **æ¶æ„è®¾è®¡ä¼˜ç§€**ï¼šPlanner-Executor-Reflector-Aggregator æ¨¡å¼ï¼Œæ˜“äºæ‰©å±•
2. **å¯è§‚æµ‹æ€§å®Œå¤‡**ï¼šç»“æ„åŒ–æ—¥å¿— + è¿½è¸ª + æŒ‡æ ‡ä¸‰ä½ä¸€ä½“
3. **å®‰å…¨æ„è¯†å¼º**ï¼šPII æ£€æµ‹ã€Prompt Injection é˜²æŠ¤ã€Secret ç®¡ç†
4. **æµ‹è¯•è¦†ç›–è‰¯å¥½**ï¼š205 ä¸ªæµ‹è¯•ï¼ŒCI é—¨ç¦å®Œæ•´
5. **æ–‡æ¡£é½å…¨**ï¼šSOPã€å¼€å‘è§„èŒƒã€API å¥‘çº¦å®Œæ•´

### âš ï¸ å¾…æ”¹è¿›

1. **æ–‡æ¡£/å®ç°å£å¾„å·®å¼‚**ï¼šSSE å¿ƒè·³ã€Chat relook è¾¹ç•Œ
2. **ç”Ÿäº§åŒ–å®Œå–„**ï¼šWorker åŒ–ã€å‘Šè­¦é…ç½®
3. **æµ‹è¯•è¡¥é½**ï¼šE2E å†’çƒŸã€è¾¹ç•Œæ¡ä»¶

### ğŸ“Š æœ€ç»ˆè¯„çº§

| è¯„çº§ | è¯´æ˜ |
|------|------|
| **B+** | **å¯ä¸Šçº¿ï¼Œéœ€å…³æ³¨æ ‡æ³¨é—®é¢˜åæŒç»­è¿­ä»£** |

---

> æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š2025-12-28 18:58
> è¯„ä¼°äººï¼šAntigravity AI
