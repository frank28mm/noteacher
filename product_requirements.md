# Product Requirements & Design Decisions

## 1. 核心业务流程与用户旅程 (Core Business Flow)

### 1.1 操作模式 (Input Workflow)
*   **用户角色**：家长 或 学生（均可操作）。
*   **处理模式**：**异步/批量处理 (Scenario B)**。
    *   用户拍摄多张作业照片（支持一次性上传）。
    *   系统后台进行识别与批改。
    *   处理完成后发送通知提醒用户查看。
*   **覆盖科目**：仅限 **数学** 和 **英语**。

### 1.2 交互模式 (Interaction Mode)
*   **指导风格**：**苏格拉底式引导 (Mode B)**。
    *   Agent **严禁**直接给出答案。
    *   通过提示 (Hint)、反问、分步引导的方式帮助学生思考。
    *   **终止机制**：交互上限为 **5次**。若此时学生仍未掌握，Agent 主动降级，直接给出详细解析。
    *   **部分正确的引导策略**：
        * 定位优先级：逐步校验时只指出首个错误步骤；步骤均对但答案错时，提示“复核最后一步计算/抄写”，不直接给答案。
        * 提示递进：第1轮轻提示（复述已对部分，聚焦疑点）；第2轮方向提示（指出检查点/公式）；第3轮重提示（指出错误类型或位置，不给结果）；第5次仍未修正则按终止机制给详细解析。
        * 结构化反馈：`steps` 中用 `verdict` 标记 correct/incorrect/uncertain，可选 `severity`（计算错误/概念错误/格式）。
        * 几何题：作图对但标注缺失则提示标注；辅助线错误则指出错误线段/关系，但不直接给正确作法，按上述递进。
*   **答案获取**：完整答案和解析仅在“错题本/错题库”中可查看，不在辅导对话中直接直接提供（除非多次引导失败，待定）。

### 1.3 数据闭环 (Data Loop)
*   **错题归档机制**：**人工确认入库**。
    *   Agent 识别并标记错题。
    *   用户（家长/学生）手动复核：
        *   确认是错题。
        *   确认OCR/识别内容无误。
    *   确认后存入“错题数据库”。
*   **目的**：确保数据清洗质量，建立高精度的个性化学习档案。

## 2. Agent 能力边界 (Agent Capabilities)

### 2.1 识别能力 (Recognition)
*   **输入支持**：
    *   支持 **完全手写体** (如抄写本) 与 印刷体/手写混排。
    *   支持 **多图关联/跨页处理** (Cross-page context)，解决题目与答案分离或长篇阅读理解的问题。
    *   **学科边界**：严格遵循 `Subject` 字段。若数学作业中出现英语单词，或英语中出现计算式，除非影响题目理解，否则**忽略**非当前学科内容。

### 2.2 数学批改 (Math Grading)
*   **深度批改**：
    *   必须识别并校验 **计算过程** (Step-by-step verification)，而不仅是最终答案。
    *   必须支持 **几何图形识别** (Geometric figures)，能够判断辅助线、几何标记是否正确。
    *   **输出形式**：Phase 1 输出"结构化字段 + 文本描述"，不做图像标注坐标：
        * `steps` 数组：`index`, `verdict`(correct/incorrect/uncertain), `expected`, `observed`, `hint`（苏格拉底式引导），可选 `severity`/`category`（计算错误/概念错误/格式）。
        * `geometry`：文本判断（例：“辅助线 BE 画对了；∠ABC 标注缺失”），可选 `elements` 列表（type: line/angle/point; label: A,B,C; status: correct/missing/misplaced）。
    *   如后续需要步骤/几何高亮，可在错误项中补充可选 `bbox`，沿用统一坐标系。

### 2.3 英语批改 (English Grading)
*   **范围限制**：Phase 1 (MVP版本) **不包含** 作文批改。
*   **主观题逻辑**：**B. 语义相似度 (Semantic Similarity)**。
    *   判分以语义相似度为主：`normal` 档阈值默认 ~0.85，可微调；不做关键词硬性校验。
    *   `strict` 档：语义相似度阈值默认 ~0.91；LLM 自动从标准答案提炼 1–3 个关键术语做内部校验（默认 AND），需同时满足“相似度 ≥ 阈值且关键术语均出现”才判对。
    *   关键术语提炼对用户透明；无用户配置入口。如提炼失败/置信度低，则仅按语义相似度判定，避免误杀。

### 2.4 上下文与记忆 (Context & Memory)
*   **范围**：仅限于 **当前作业批次 (Session-based)**。
    *   能够识别本次作业中的重复错误模式并进行提示。
    *   不跨作业批次调用历史记忆进行辅导。
*   **批次定义与生命周期**：一次上传的一组作业视为一个批次，会话生命周期最长 24 小时；超时后会话作为历史记录持久化，不清空上下文。
*   **长期画像读写边界**：辅导对话链条严禁读取长期画像/错题库，只在批次结束后写入（或在错题人工确认后写入）；推荐/总结类接口可读取历史画像和错题库。
*   **Agent 硬约束**：在 Agent 层强制执行上述隔离——辅导链禁止读取历史画像/错题库；推荐/报告链可读取历史用于长期分析。
*   **对话历史持久化**：当前批次内的对话历史持久化到云端，支持多端续接；退出后再次进入需恢复上下文。
*   **跨学科/混合内容处理**：用户上传前需选择科目（数学/英语），系统按所选科目判题，默认不自动切科。
    * 轻量科目检测（OCR 特征）仅用于提示：若检测到与所选科目强冲突，可在报告标记“疑似科目不匹配”，不混用另一科模型。
    * 数学题为英文表述：仍按数学链处理；仅在数学特征极低且文本明显为英语阅读时提示可能不匹配。
    * 英语题含算式：仍按英语链处理，算式按文本处理，必要时提示“含算式，当前以英语语义相似度判定，可能影响准确度”。
    * 不做“双判”或自动切换科目，检测只做标记/提示，不中断批改。

## 3. 数据模型与个性化 (Data Model & Personalization)

### 3.1 错题数据结构 (Error Data Structure)
*   **双重存储策略**：
    *   **核心资产 (Review Slice)**：截取 "题干区域 + 学生错答区域" 的组合切片，用于制作电子错题本和复习卡片。
    *   **上下文回溯 (Context Snapshot)**：保留 "整页原始快照"，并记录错题在整页中的坐标 (Bounding Box)。
    *   **坐标系标准**：统一采用 **归一化坐标 (Normalized [0-1])** `[ymin, xmin, ymax, xmax]`，原点左上，y 向下，独立于分辨率，便于多端适配。
    *   **错题存储字段参考**：`page_image_url`（整页）、`slice_image_url`（裁剪片）、`page_bbox`（整页中的 bbox）、`review_slice_bbox`（题干+错答切片 bbox）；如需步骤级高亮，可在 steps/geometry 里使用相同归一化 bbox。

### 3.2 学生画像粒度 (Student Profile Granularity)
*   **L2 知识点分类 (Knowledge Graph Tagging)**：
    *   利用 LLM 的通用知识能力进行**自动打标**。
    *   标签层级示例：`数学` -> `几何` -> `三角形` -> `全等三角形判定`。
*   **分析维度**：基于知识标签统计掌握率，生成“知识雷达图”。

## 4. 接口协议与架构 (Interface & Architecture)

### 4.1 通信协议 (Protocol)
*   **流式交互 (Streaming)**：采用 **SSE (Server-Sent Events)** 协议。
    *   目的：支持 Agent 较长的思考推理过程，实现“打字机”即时反馈效果，避免客户端超时等待。
    *   实时/流式场景（苏格拉底对话、小批量批改）：Node ⇄ Python 直连 HTTP + SSE，单次超时 60s，可重试 1 次，需携带 idempotency-key 防重复；SSE 保持心跳，断线可选用 last-event-id 续接。
    *   异步长任务（批量/多页批改）：Node 通过 HTTP 提交任务，Python 接收后内部入队（本地队列/Redis）。状态回传可用 webhook 回调（失败重试 ≤3 次，指数退避）或 Node 轮询任务状态接口；任务创建请求超时 60s，可重试 1 次，需 idempotency-key。
    *   MVP 不要求 Node 直接接入 MQ，若后续并发/弹性需求提升，可在 Python 内部替换为 Redis/Rabbit/Kafka 作为 worker broker，Node 侧保持 HTTP+回调模式。

### 4.2 数据同步策略 (Data Sync)
*   **云端为本 (Cloud-First)**：
    *   所有核心数据（错题、对话历史、配置）均存储在云端数据库。
    *   客户端（iOS/Android/Harmony）仅做轻量级展示与缓存，支持多端切换无缝流转。

### 4.3 服务形态 (Service Topology)
*   **独立 Agent 服务 (Microservice)**：
    *   将作业检查核心逻辑封装为独立的微服务 (Agent Service)。
    *   **内部通信**：BFF 与 Agent 之间采用 **HTTP (REST)** 直接调用，避免引入 MQ 增加复杂度。
    *   通过 API 网关对各端提供统一服务，实现核心业务逻辑解耦。

### 4.4 技术双引擎 (Dual-Engine Stack)
*   **前端交互层 (BFF)**: Node.js (NestJS/Koa)
    *   处理 WebSocket/SSE 连接、业务逻辑、用户鉴权。
*   **AI 计算层 (Core Engine)**: Python (FastAPI)
    *   专注图像识别、逻辑推理、Agent 编排 (LangChain)。
