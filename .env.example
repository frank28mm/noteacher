# OpenAI (可选主模型)
OPENAI_API_KEY=
OPENAI_BASE_URL=https://api.openai.com/v1
MODEL_REASONING=gpt-4o
MODEL_VISION=gpt-4o

# SiliconFlow - Qwen3-VL (视觉)
SILICON_API_KEY=
SILICON_BASE_URL=https://api.siliconflow.cn/v1
SILICON_VISION_MODEL=Qwen/Qwen3-VL-32B-Thinking
SILICON_REASONING_MODEL=Qwen/Qwen2.5-72B-Instruct

# 火山方舟 - Doubao 视觉
ARK_API_KEY=
ARK_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
ARK_VISION_MODEL=doubao-seed-1-6-vision-250815
ARK_REPORT_MODEL=doubao-seed-1-6-251015
# Ark Responses 内置 image_process 工具（zoom/rotate/grounding/point）
ARK_IMAGE_PROCESS_ENABLED=0
# Ark Responses API 输出长度上限（max_output_tokens）。默认关闭：deep-thinking 模型可能把预算全部用于 reasoning，
# 导致没有最终 output_text（进而触发 parse_failed）。只在明确验证后再打开。
ARK_RESPONSES_ENABLE_OUTPUT_CAP=0
# /grade 图片输入策略：url|auto|proxy|data_url_first_page|data_url_on_small_figure
# 当前默认推荐：url（先把性能/质量基线钉死；proxy 闭环修好后再验证是否值得切换）
GRADE_IMAGE_INPUT_VARIANT=url
# /grade 快路径预处理：qindex_only|off|full
# - qindex_only：仅复用 qindex 缓存切片；未命中则跳过（推荐默认，速度接近 off）
# - off：完全跳过预处理（最快，但切片证据更少）
# - full：qindex cache -> VLM locator -> OpenCV fallback（最慢，覆盖更强）
AUTONOMOUS_PREPROCESS_MODE=qindex_only
# 火山方舟 - Doubao 推理（grade/chat）
ARK_REASONING_MODEL=doubao-seed-1-6-vision-250815

# Supabase (Storage + Database)
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key
# Worker-only secret (never commit; store in secret manager / runtime env only)
SUPABASE_SERVICE_ROLE_KEY=
SUPABASE_BUCKET=homework-images
DEV_USER_ID=dev_user
AUTH_REQUIRED=0
SUPABASE_DB_URL="postgresql://postgres:[PASSWORD]@[HOST]:5432/postgres"

# Reports
# - Narrative layer calls LLM; set to 0 to disable.
REPORT_NARRATIVE_ENABLED=1

# OCR / QIndex (bbox/切片)
# 用于“题号定位/切片裁剪”的版面分析 provider（输出每题 bbox）
# - 默认推荐：siliconflow_qwen3_vl（Qwen3-VL 输出题号+bbox，能生成切片）
# - 兼容：siliconflow_deepseek（DeepSeek-OCR 主要输出纯文本；bbox 不稳定，可能生成 0 切片）
# - 可禁用：OCR_PROVIDER=disabled（将跳过 qindex/bbox/切片）
OCR_PROVIDER=siliconflow_deepseek

# QIndex 定位模型（bbox-only，SiliconFlow Chat Completions）
# QIndex Locator (Ark)
ARK_QINDEX_MODEL=doubao-seed-1-6-vision-250815
ARK_QINDEX_TIMEOUT_SECONDS=180

# QIndex Locator (SiliconFlow) - optional
# 注意：Doubao 模型属于 Ark，请用 ARK_QINDEX_MODEL；不要把 doubao-* 填到 SILICON_QINDEX_MODEL
SILICON_QINDEX_MODEL=Qwen/Qwen3-VL-32B-Thinking
SILICON_QINDEX_TIMEOUT_SECONDS=180
SILICON_QINDEX_MAX_TOKENS=900

# DeepSeek OCR（文本OCR，可选）
SILICON_OCR_MODEL=deepseek-ai/DeepSeek-OCR
SILICON_OCR_TIMEOUT_SECONDS=60
SILICON_OCR_MAX_TOKENS=2048

# Baidu PaddleOCR-VL (OCR + 版面分析)
# 已暂停（额度太少），保留配置仅用于未来切回：
# 获取 access_token:
#   https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=<API_KEY>&client_secret=<SECRET_KEY>
BAIDU_OCR_API_KEY=
BAIDU_OCR_SECRET_KEY=
BAIDU_OCR_OAUTH_URL=https://aip.baidubce.com/oauth/2.0/token
# 文档解析（PaddleOCR-VL）
BAIDU_OCR_SUBMIT_URL=https://aip.baidubce.com/rest/2.0/brain/online/v2/paddle-vl-parser/task
BAIDU_OCR_QUERY_URL=https://aip.baidubce.com/rest/2.0/brain/online/v2/paddle-vl-parser/task/query
# 轮询/超时（可选）
BAIDU_OCR_TIMEOUT_SECONDS=60
# 文档建议提交后 5～10 秒轮询；过快可能触发 QPS 限制
BAIDU_OCR_POLL_INTERVAL_SECONDS=5
BAIDU_OCR_POLL_MAX_SECONDS=60

# BBox + Slice（切片生成）
SLICE_PADDING_RATIO=0.05
SLICE_TTL_SECONDS=86400

# Chat (SSE)
# - SSE 心跳间隔（默认 30s）
CHAT_HEARTBEAT_INTERVAL_SECONDS=30
# - 兜底断线：LLM 长时间无输出时主动关闭 SSE（默认 0=关闭；生产建议先取 120，再按日志回调）
CHAT_IDLE_DISCONNECT_SECONDS=0
# - 消费者提前结束时，producer join 的最大等待时间（默认 5s）
CHAT_PRODUCER_JOIN_TIMEOUT_SECONDS=5

# SLA / Time budgets（秒）
# - 完成 SLA：允许慢图/慢推理，但必须在该时间内结束（否则返回失败）
# - Vision/LLM 子预算：用于快速失败和避免线程堆积
GRADE_COMPLETION_SLA_SECONDS=600
GRADE_VISION_TIMEOUT_SECONDS=240
GRADE_LLM_TIMEOUT_SECONDS=300
VISION_CLIENT_TIMEOUT_SECONDS=240
LLM_CLIENT_TIMEOUT_SECONDS=300

# 并发限制（避免阻塞调用堆积）
MAX_CONCURRENT_VISION=2
MAX_CONCURRENT_LLM=4

# Unified Vision-Grade Agent
ENABLE_UNIFIED_VISION_GRADE=0
UNIFIED_AGENT_FALLBACK_TO_LEGACY=0
UNIFIED_AGENT_MAX_CONCURRENCY=2
UNIFIED_AGENT_TIMEOUT_SECONDS=600
UNIFIED_AGENT_MAX_TOKENS=1600
JSON_REPAIR_MAX_ATTEMPTS=1
JUDGMENT_BASIS_MIN_LENGTH=2
# 数学题步骤保留上限（用于“计算习惯”过程诊断；仅对 incorrect/uncertain 生效）
MAX_MATH_STEPS_PER_QUESTION=5
OPENCV_PROCESSING_TIMEOUT=30
OPENCV_PROCESSING_MAX_BYTES=20971520

# Demo UI 客户端超时（必须 >= GRADE_COMPLETION_SLA_SECONDS，否则 UI 可能先超时显示“系统报错”但后端仍在运行）
DEMO_GRADE_TIMEOUT_SECONDS=660
DEMO_AUTH_TOKEN=

# QIndex worker queue（需要 Redis）
QINDEX_QUEUE_NAME=qindex:queue
# Derived facts worker queue（question_attempts/question_steps，需 Redis）
FACTS_QUEUE_NAME=facts:queue
FACTS_LOCK_TTL_SECONDS=600

# Redis（cache + queue；API 与 worker 必须同源）
REDIS_URL=redis://127.0.0.1:6379/0
CACHE_PREFIX=

# 通用
LOG_LEVEL=INFO
LOG_TO_FILE=1
LOG_FILE_PATH=logs/backend.log
API_BASE_URL=http://127.0.0.1:8000/api/v1
